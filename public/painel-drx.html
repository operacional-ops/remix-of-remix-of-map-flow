<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRX Flow | Team Flow</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { 
            background-color: #020617; 
            color: #cbd5e1; 
            font-family: 'Inter', sans-serif; 
            overflow: auto; 
            margin: 0;
            padding: 0;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass-panel { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
            border-radius: 0.75rem;
        }

        .animate-enter { animation: enter 0.4s ease-out forwards; }
        @keyframes enter {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-card { transition: all 0.2s; }
        .task-card:hover { transform: translateY(-2px); border-color: #3b82f6; }
        
        /* Checkbox Customizado */
        .custom-checkbox input:checked + div { background-color: #10b981; border-color: #10b981; }
        .custom-checkbox input:checked + div svg { display: block; }

        /* Estilos de Texto do Cargo */
        .role-section h4 { color: #60a5fa; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .role-section ul { list-style: none; padding: 0; margin-bottom: 1rem; }
        .role-section li { position: relative; padding-left: 1rem; margin-bottom: 0.25rem; font-size: 0.85rem; color: #94a3b8; line-height: 1.4; }
        .role-section li::before { content: "•"; position: absolute; left: 0; color: #475569; }
        
        .footer-input:focus-within { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.15); }

        /* Tutorial styles */
        .tut-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.35); pointer-events: none; }
        .tut-card { 
            position: fixed; z-index: 201; 
            background: rgba(15, 23, 42, 0.92); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 12px; 
            padding: 16px; 
            max-width: 300px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            cursor: grab;
            user-select: none;
            pointer-events: all;
        }
        .tut-card.dragging { cursor: grabbing; }
        .tut-arrow { 
            color: #3b82f6; 
            filter: drop-shadow(0 0 6px rgba(59,130,246,0.5)); 
            animation: tut-bounce 1s infinite; 
        }
        @keyframes tut-bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-8px); }
        }
        @keyframes tut-bounce-down {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(8px); }
        }
        .tut-arrow-down { animation: tut-bounce-down 1s infinite; }
        .tut-dot { width: 6px; height: 6px; border-radius: 50%; background: #334155; transition: all 0.3s; }
        .tut-dot.active { width: 16px; border-radius: 3px; background: #3b82f6; }
        .tut-dot.done { background: rgba(59,130,246,0.4); }
        .tut-highlight { position: relative; z-index: 201 !important; box-shadow: 0 0 0 3px rgba(59,130,246,0.5), 0 0 16px rgba(59,130,246,0.3) !important; border-radius: 8px; }
        .tut-btn { 
            background: linear-gradient(135deg, #3b82f6, #6366f1); 
            border: none; color: white; 
            padding: 4px 12px; border-radius: 6px; 
            font-size: 11px; font-weight: 700; 
            cursor: pointer; 
            display: flex; align-items: center; gap: 4px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }
        .tut-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* Truncate helpers */
        .name-truncate { 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            max-width: 100%; 
            display: block;
        }

        /* Mobile-first responsive fixes */
        @media (max-width: 768px) {
            .login-board-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .login-team-grid { grid-template-columns: 1fr !important; }
            .login-wrapper { padding: 0.75rem !important; }
            .login-title { font-size: 1.5rem !important; }
            .workspace-header { padding: 0.5rem 0.75rem !important; }
            .workspace-header nav { display: none !important; }
            .workspace-mobile-nav { display: flex !important; }
            .prep-grid { grid-template-columns: 1fr !important; }
            .prep-details { max-height: none !important; }
            
            /* GodView mobile */
            .godview-members-strip { flex-wrap: wrap !important; overflow-x: visible !important; }
            .godview-main-flex { flex-direction: column !important; }
            .godview-kanban-panel { min-height: 350px !important; }
            .godview-inbox-panel { width: 100% !important; min-height: 250px !important; max-height: 300px !important; }
            
            /* Kanban mobile */
            .kanban-columns { flex-direction: column !important; overflow-x: visible !important; gap: 0.5rem !important; }
            .kanban-columns > div { min-width: 100% !important; max-height: 280px !important; }
            
            /* Inbox mobile */
            .inbox-main { padding: 0.75rem !important; }
            .inbox-main h2 { font-size: 1rem !important; margin-bottom: 0.75rem !important; }

            /* Login cards mobile */
            .login-card-inner { gap: 0.5rem !important; padding: 0.625rem !important; }
            .login-card-inner .login-avatar { width: 2rem !important; height: 2rem !important; font-size: 0.7rem !important; }
            .login-card-inner .login-name { font-size: 0.7rem !important; }
            .login-card-inner .login-role { font-size: 8px !important; }
        }
        @media (min-width: 769px) {
            .workspace-mobile-nav { display: none !important; }
        }
        @media (max-width: 480px) {
            .login-board-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 0.375rem !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyCn9Cn7WKZW_XEI-HB8XN9F9HMrFzEq4XM",
            authDomain: "drx-operacao-painel.firebaseapp.com",
            projectId: "drx-operacao-painel",
            storageBucket: "drx-operacao-painel.firebasestorage.app",
            messagingSenderId: "273921323746",
            appId: "1:273921323746:web:f69935abf568005c98a4bb",
            measurementId: "G-S17MHC2JND"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- CONSTANTES DE ACESSO ---
        const SUPERVISORS = ['danillo', 'arthur', 'brandon'];
        
        // Quem pode ADICIONAR tarefas no quadro dos outros (Mantendo original)
        // E agora também usado para verificação de quem pode editar qualquer tarefa
        const TASK_EDITORS = ['danillo', 'arthur'];

        // --- LISTA NEGRA DE TAREFAS BUGADAS (HARDCODED FIX) ---
        const GHOST_TASKS = [
            "pegando ideias para roteiro asdsadas",
            "pegando ideias para roteiro (Cópia)g",
            "pegando ideias para roteiro (Cópia)"
        ];

        // --- DADOS DA EQUIPE (COM CREDENCIAIS) ---
        const TEAM_DATA = [
            { id: 'danillo', name: 'Ailton Danillo', role: 'Diretor de Operações (COO)', category: 'board', avatar: 'AD', color: 'bg-blue-600', isDirector: true, user: 'ailtonadm', pass: 'DRX2026@' },
            { id: 'arthur', name: 'Arthur', role: 'Head de Estratégia', category: 'board', avatar: 'AR', color: 'bg-purple-600', isDirector: true, user: 'arthuradm', pass: 'DRX2026@' },
            { id: 'brandon', name: 'Brandon', role: 'CEO / Expansão', category: 'board', avatar: 'BR', color: 'bg-indigo-600', isDirector: true, user: 'brandonadm', pass: 'DRX2026@' },
            { id: 'andre', name: 'Andre', role: 'Diretor Financeiro (CFO)', category: 'board', avatar: 'AN', color: 'bg-emerald-700', isDirector: true, user: 'andreadm', pass: 'DRX2026@' },
            { id: 'marcos', name: 'Marcos Vinicius', role: 'Diretor de Copy', category: 'board', avatar: 'MV', color: 'bg-rose-600', isDirector: true, user: 'marcosadm', pass: 'DRX2026@' },
            { id: 'lucas', name: 'Lucas Rosário', role: 'Diretor de Tráfego', category: 'board', avatar: 'LR', color: 'bg-orange-600', isDirector: true, user: 'lucasadm', pass: 'DRX2026@' },
            
            { id: 'impactize', name: 'Impactize (Editor VSL)', role: 'Edição de VSL & Criativos', category: 'team', avatar: 'IM', color: 'bg-red-600', isDirector: false, user: 'impactizeadm', pass: 'DRX2026@' },
            { id: 'gabriel', name: 'Gabriel Gomes', role: 'Copywriter Pleno', category: 'team', avatar: 'GG', color: 'bg-pink-500', isDirector: false, user: 'gabrieladm', pass: 'DRX2026@' },
            { id: 'pedro', name: 'Pedro Severo', role: 'Infraestrutura Pleno', category: 'team', avatar: 'PS', color: 'bg-cyan-600', isDirector: false, user: 'pedroadm', pass: 'DRX2026@' },
            { id: 'felipe', name: 'Felipe Origuela', role: 'Filmmaker Sênior', category: 'team', avatar: 'FO', color: 'bg-yellow-600', isDirector: false, user: 'felipeadm', pass: 'DRX2026@' },
            { id: 'victor', name: 'Victor Navega', role: 'Editor de Vídeos', category: 'team', avatar: 'VN', color: 'bg-teal-500', isDirector: false, user: 'victoradm', pass: 'DRX2026@' },
            { id: 'bruno', name: 'Bruno Brittes', role: 'Social Media', category: 'team', avatar: 'BB', color: 'bg-fuchsia-500', isDirector: false, user: 'brunoadm', pass: 'DRX2026@' },
            { id: 'evelin', name: 'Evelin', role: 'Facilities & Apoio', category: 'team', avatar: 'EV', color: 'bg-lime-600', isDirector: false, user: 'evelinadm', pass: 'DRX2026@' }
        ];

        // --- CONTEÚDO DOS RITUAIS (PDF) ---
        const DAILY_CONTENT = {
            'rules': [
                "Sem atraso. Começa no horário com quem estiver.",
                "Todos de câmera ligada, momento de total foco.",
                "Sem discussão longa. Assunto complexo → reunião separada.",
                "Se não gera ação, não entra.",
                "Decisão pequena acontece ali. Decisão grande vai para a estratégica."
            ],
            'forbidden': [
                "Brainstorm de copy",
                "Debate de métrica",
                "Revisão de criativo",
                "Explicação longa de problema",
                "Discussão emocional",
                "Aula de marketing"
            ],
            'structure': [
                { role: "Arthur (Estratégia)", time: "2 min", what: ["Funis ativos hoje", "Objetivo do dia (teste, escala, ajuste, pausa)", "Alguma mudança estratégica?"] },
                { role: "Lucas (Tráfego)", time: "3 min", what: ["O que rodou ontem", "Algum número fora do esperado", "Algum risco imediato", "Ação principal hoje"] },
                { role: "Marcos (Copy)", time: "3 min", what: ["O que foi entregue ontem", "O que entra em produção hoje", "Dificuldade de copy/Bloqueio criativo", "Sugestão de ajuste em funil"] },
                { role: "Liwerton/Impactize (Edição)", time: "2 min", what: ["Status das peças em edição", "Próximas entregas do dia", "Algum bloqueio técnico ou operacional"] },
                { role: "Danillo (Operações)", time: "3 min", what: ["Algum risco operacional ativo", "Algum incidente", "Algo que pode parar o funil hoje"] }
            ]
        };

        const WEEKLY_CONTENT = {
            'structure': [
                { topic: "1. O que GANHOU dinheiro", owner: "Lucas (5 min)", details: ["Qual funil gerou lucro", "Quais criativos performaram", "Qual padrão aparece"] },
                { topic: "2. O que PERDEU dinheiro", owner: "Lucas (5 min)", details: ["Onde houve prejuízo", "O que já pode ser descartado", "Algum risco emergente (Sem justificativa emocional, só dados)"] },
                { topic: "3. Leitura de Mensagem & Copy", owner: "Marcos (7 min)", details: ["Qual ângulo funcionou", "Qual promessa perdeu força", "Qual padrão de narrativa aparece", "O que NÃO devemos repetir"] },
                { topic: "4. Síntese Estratégica", owner: "Arthur (8 min)", details: ["O que escala", "O que pausa", "O que morre", "O que entra em teste", "Prioridade da próxima semana"] }
            ],
            'outputs': [
                "Lista de vencedores", "Lista de descartados", "Hipóteses da próxima semana", "Prioridade única de foco", "Decisões registradas"
            ]
        };

        // --- DETALHES DOS CARGOS (PDF) ---
        const ROLE_DETAILS = {
            'danillo': { mission: "Garantir que os funis funcionem sem falhas, com estabilidade operacional, SLA cumprido e risco controlado.", nonNegotiables: ["Manter bom relacionamento de toda equipe.", "Manter comunicação alinhada entre tríade (Copy - Tráfego - Edição).", "Resolver gargalos operacionais com rapidez.", "Monitorar riscos operacionais (Toda Infra de Pé).", "Documentar incidentes e correções."], limits: ["Não decide estratégia de funil.", "Não muda promessa ou copy.", "Não altera orçamento.", "Não prioriza testes.", "Não negocia com experts."], decisions: ["Ajustes técnicos e operacionais.", "Pausar funil por risco operacional.", "Priorizar correções emergenciais.", "Definir rotinas operacionais."], behavior: ["Antecipar riscos.", "Resolver sem criar ruído.", "Manter disciplina operacional."] },
            'arthur': { mission: "Ser dono do resultado econômico dos funis, definindo estratégia, prioridade e alocação de capital para maximizar crescimento.", nonNegotiables: ["Decidir o que nasce, o que escala e o que morre.", "Priorizar funis e testes semanalmente.", "Alocar budget por funil.", "Orquestrar Copy, Tráfego e Operações sem executar tarefas."], limits: ["Não escreve copy.", "Não sobe/otimiza campanhas.", "Não resolve problemas operacionais.", "Não negocia com experts/parceiros.", "Não microgerencia execução."], decisions: ["Criar/encerrar funil.", "Escalar/pausar funil por performance.", "Definir prioridades da semana.", "Redirecionar budget entre funis."], behavior: ["Trazer resultado interno para empresa.", "Definir prioridades semanais do time.", "Tomar as decisões estratégicas com base em dados."] },
            'brandon': { mission: "Maximizar o valor da empresa no médio e longo prazo, garantindo expansão estratégica e relações externas sólidas.", nonNegotiables: ["Conduzir relacionamento com experts e parceiros.", "Liderar negociações externas.", "Buscar novas oportunidades de funis.", "Garantir governança entre estratégia, operação e expansão."], limits: ["Não define promessa, mecanismo ou ICP.", "Não decide criar, escalar ou matar funil.", "Não altera estratégia de tráfego ou copy.", "Não interfere na operação diária."], decisions: ["Escolha e negociação com experts.", "Definição de acordos comerciais.", "Posicionamento institucional.", "Iniciativas de expansão."], behavior: ["Pensar em empresa vendável.", "Proteger a operação de interferências externas.", "Canalizar demandas externas para o Núcleo Estratégico."] },
            'andre': { mission: "Garantir clareza financeira, controle de caixa e previsibilidade econômica.", nonNegotiables: ["Manter fluxo de caixa atualizado (DFC).", "Garantir liquidez mínima de segurança.", "Construir DRE gerencial semanal.", "Identificar pontos de prejuízo."], limits: ["Não escala investimento em tráfego sozinho.", "Não bloqueia estratégia sem alinhamento.", "Não redireciona capital entre funis por conta própria."], decisions: ["Priorizar pagamentos dentro do orçamento.", "Sugerir redução de custos.", "Alertar necessidade de pausa por risco de caixa."], behavior: ["Financeiro alerta. Estratégia decide.", "Nenhuma decisão estratégica relevante acontece sem visibilidade financeira."] },
            'marcos': { mission: "Dirigir a comunicação persuasiva e garantir a qualidade dos ativos de conversão.", nonNegotiables: ["Direcionar quais ângulos e formatos escrever.", "Escrever ativos de copy (VSL, Criativos, E-mails).", "Preencher Airtable com infos dos ativos.", "Revisar edição dos ativos escritos."], limits: ["Não decide budget de tráfego.", "Não interfere na infraestrutura técnica.", "Não negocia contratos."], decisions: ["Ajustes na copy pra performance.", "Prioridade nos testes da esteira de otimização.", "Definir próxima offer para esteira de ripagem."], behavior: ["Pensar em padrões, não ativos isolados.", "Executar rápido, sem ego.", "Registrar aprendizados sempre."] },
            'lucas': { mission: "Maximizar o retorno sobre o investimento (ROAS) através da gestão técnica de mídia paga.", nonNegotiables: ["Subir, testar e otimizar campanhas.", "Executar os testes definidos pela estratégia.", "Garantir controle de CAC, ROAS e spend.", "Gerar relatórios claros."], limits: ["Não altera a copy sem aval.", "Não define a oferta macro (papel da estratégia)."], decisions: ["Estrutura de campanhas.", "Alocação de budget dentro do funil ativo.", "Pausa técnica de criativos ou campanhas."], behavior: ["Agir com dados, não com opinião.", "Executar rápido e documentar.", "Priorizar eficiência sobre ego."] },
            'impactize': { mission: "Transformar o roteiro de vendas (Copy) em uma experiência visual hipnótica e persuasiva.", nonNegotiables: ["Produzir vídeos de vendas seguindo rigorosamente o script.", "Narrativa Visual (B-rolls corretos).", "Sound Design que conduza a emoção.", "Cumprimento de Prazos (Deadline).", "Revisão 100% antes da entrega."], limits: ["Não altera o texto da Copy.", "Não muda o Briefing (ex: trocar tensão por alegria)."], decisions: ["Escolha criativa das cenas.", "Estilo das transições e tipografia.", "Ajustes de áudio (mixagem).", "Sugerir mudanças visuais se o roteiro estiver lento."], behavior: ["Visão de Vendas (vídeo é conversão).", "Sempre entregar material revisado.", "Sigilo Absoluto dos materiais."] },
            'gabriel': { mission: "Garantir a tração e a escala das ofertas através dos seus ativos de copy.", nonNegotiables: ["Produção semanal de ativos de copy.", "Estudo de Público e Pesquisa.", "Espionagem de Mercado (novas ofertas).", "Revisão final dos materiais."], limits: ["Não define o que fazer (segue demanda).", "Não sobe campanhas no gerenciador."], decisions: ["O 'como' criar cada ativo (liberdade criativa no texto)."], behavior: ["Coragem criativa para testar ideias.", "Feedback constante para melhorias.", "Resiliência Criativa (testes falham, continue)."] },
            'pedro': { mission: "Garantir toda infraestrutura da operação (Sites, Rastreamento, Ferramentas).", nonNegotiables: ["Configuração de domínios, DNS e servidores.", "Rastreamento (Pixels, CAPI, UTMs).", "Criar e otimizar checkouts e funis.", "Configurar VSL na Vturb e testes A/B."], limits: ["Não define orçamento de ferramentas.", "Não cria copy.", "Não negocia taxas de gateways."], decisions: ["Solicitação de compra de ativos (Proxies, Domínios).", "Escolha técnica de implementação.", "Troca de servidor em emergência."], behavior: ["Mindset Preventivo (check-up diário).", "Organização Extrema de acessos.", "Agilidade na Crise (site caiu = prioridade zero)."] },
            'felipe': { mission: "Elevar o padrão visual da DRX e dos Experts através de produções cinematográficas.", nonNegotiables: ["Captação e Edição de Conteúdo Expert.", "Gestão e manutenção de Equipamentos.", "Direção de Fotografia em gravações.", "Backup e Organização do acervo (RAW)."], limits: ["NÃO edita VSLs (Função da Impactize).", "NÃO interfere na estratégia de VSL.", "Não assume demanda de volume (Reels diários)."], decisions: ["Direção de Cena (parar se luz/som estiver ruim).", "Definir Color Grading e identidade visual.", "Veto Técnico de material ruim."], behavior: ["Olhar Cinematográfico.", "Disponibilidade Técnica para captações complexas.", "Guardião da memória da empresa (arquivos)."] },
            'victor': { mission: "Materializar a estratégia orgânica em vídeos de alta retenção e qualidade.", nonNegotiables: ["Monitorar calendário orgânico diariamente.", "Executar edição completa (cortes, legendas, cor).", "Reportar problemas técnicos.", "Garantir organização no Drive."], limits: ["Não altera estratégia de conteúdo.", "Não aprova o próprio vídeo (função do Brandon).", "Não posta conteúdo final."], decisions: ["Escolha de trilhas e ritmo.", "Sugestão de ideias criativas.", "Sinalização de impedimentos."], behavior: ["Agilidade sem perder qualidade.", "Proatividade ao buscar referências.", "Resiliência para revisões."] },
            'bruno': { mission: "Gerenciar e fortalecer a presença digital institucional, criando autoridade e desejo.", nonNegotiables: ["Gestão de Perfis diária.", "Planejamento de Conteúdo e Calendário.", "Social Selling (Responder Directs).", "Agendamento e Postagem correta."], limits: ["Não interfere nas VSLs ou Copy de Vendas.", "Não altera tom de voz sem validação.", "Não faz gestão de Tráfego Pago."], decisions: ["Escolha de áudios (Trends).", "Respostas de rotina.", "Sugestão de pautas (Newsjacking)."], behavior: ["Guardião da Marca (autenticidade).", "Agilidade (tempo real).", "Ponte com a Edição."] },
            'evelin': { mission: "Garantir a fluidez operacional do escritório e da rotina dos sócios.", nonNegotiables: ["Gestão de Agenda (Sócios).", "Execução de Pagamentos (Cartão Corporativo).", "Facilities (Limpeza, Insumos).", "Prestação de Contas imediata (comprovantes)."], limits: ["Não gasta sem 'OK' do Financeiro.", "Não excede Teto Diário.", "Não empresta o cartão.", "Não negocia grandes contratos."], decisions: ["Solicitar Ubers para convidados.", "Compra de insumos de recorrência.", "Acionar manutenção de urgência."], behavior: ["Disciplina Financeira (justificar cada centavo).", "Agilidade com Comprovantes.", "Discrição e Sigilo."] }
        };

        // --- CHECKLISTS ---
        const CHECKLISTS = {
            'default': ["Organizar ambiente de trabalho", "Checar agenda do dia", "Definir prioridade única"],
            'impactize': ["Ler Briefing/Roteiro do Marcos com atenção", "Garantir Narrativa Visual (B-rolls corretos)", "Revisão 100% de erros antes da entrega", "Validar prazo para não travar tráfego"],
            'gabriel': ["Checar demandas do Marcos (Diretor)", "Estudar referências/público (15min)", "Revisar ativos de copy pendentes", "Blindar agenda para escrita focada"],
            'pedro': ["Check-up de todos os funis (Páginas ON?)", "Verificar integridade dos Pixels e UTMs", "Backup de segurança dos ativos", "Checar alertas de lentidão/servidor"],
            'felipe': ["Checar equipamentos (Bateria/Cartão)", "Organizar backup de arquivos brutos (RAW)", "Alinhar demandas com Victor Navega", "Verificar agenda de gravações institucionais"],
            'victor': ["Baixar arquivos brutos do Drive/Social", "Verificar calendário de postagens com Bruno", "Organizar pastas de projetos", "Reportar problemas técnicos ao Danillo"],
            'bruno': ["Responder Directs (Social Selling)", "Verificar aprovações pendentes com Brandon", "Postar Sequência de Bom Dia (Stories)", "Checar entrega dos posts agendados"],
            'evelin': ["Checar agenda dos Sócios (Conflitos?)", "Conciliação bancária do dia anterior", "Verificar insumos do escritório", "Enviar comprovantes pendentes ao Andre"],
            'marcos': ["Alinhar produção com Impactize/Gabriel", "Revisar métricas de conversão", "Definir ângulos do dia"],
            'lucas': ["Check de Spend diário", "Análise de ROAS matinal", "Alertas de campanhas"],
            'andre': ["Verificar Saldo/Caixa", "Validar pagamentos do dia", "Atualizar DFC"],
            'danillo': ["Verificar estabilidade dos sistemas", "Checar reports de risco", "Alinhar prioridades com Arthur"],
            'arthur': ["Revisar performance macro (Ontem)", "Ajustar prioridades de teste", "Validar budget diário"],
            'brandon': ["Verificar agenda externa", "Checar métricas de expansão", "Alinhar com parceiros chave"]
        };

        // --- HELPER DE FORMATAÇÃO DE DATA ---
        // Solução para o problema da data
        const formatDate = (timestamp) => {
            if (!timestamp) return "";
            // Se for um objeto Timestamp do Firestore (tem método toDate)
            if (timestamp.toDate) {
                return timestamp.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            }
            // Se já for data JS ou número
            return new Date(timestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        // --- COMPONENTE ICON ---
        const Icon = ({ name, className }) => {
            const containerRef = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && containerRef.current) {
                    const tempIcon = document.createElement('i');
                    tempIcon.setAttribute('data-lucide', name);
                    if (className) tempIcon.className = className;
                    containerRef.current.innerHTML = '';
                    containerRef.current.appendChild(tempIcon);
                    window.lucide.createIcons({ root: containerRef.current, nameAttr: 'data-lucide' });
                }
            }, [name, className]);
            return <span ref={containerRef} style={{ display: 'contents' }}></span>;
        };

        // --- COMMENT COUNT BADGE ---
        const CommentCountBadge = ({ taskId }) => {
            const [count, setCount] = React.useState(0);
            React.useEffect(() => {
                if (!taskId) return;
                const unsub = db.collection('drx_task_comments')
                    .where('taskId', '==', taskId)
                    .onSnapshot(snap => setCount(snap.size), () => {});
                return () => unsub();
            }, [taskId]);
            if (count === 0) return null;
            return (
                <span className="flex items-center gap-0.5 text-[10px] text-slate-400">
                    <Icon name="message-square" className="w-3 h-3" /> {count}
                </span>
            );
        };

        // --- COMPONENTE CLOCK ---
        const Clock = () => {
            const [time, setTime] = React.useState(new Date());
            React.useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
            return (
                <div className="text-right">
                    <div className="text-xl font-bold text-red-500 font-mono leading-none">{time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    <div className="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-0.5">{time.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
                </div>
            );
        };

        // --- FLOATING COMMENTS PANEL ---
        const FloatingCommentsPanel = ({ taskId, comments, loadingComments, newComment, setNewComment, addComment, deleteComment, currentUser }) => {
            const [isExpanded, setIsExpanded] = React.useState(true);
            
            return (
                <div className={`fixed right-4 top-20 bottom-4 z-[60] transition-all duration-300 ${isExpanded ? 'w-80' : 'w-14'}`}>
                    <div className="glass-panel h-full flex flex-col shadow-2xl">
                        {/* Header */}
                        <div className="p-3 border-b border-slate-700 flex items-center justify-between bg-slate-900/50">
                            {isExpanded && (
                                <div className="flex items-center gap-2">
                                    <Icon name="message-square" className="w-4 h-4 text-blue-500"/>
                                    <h3 className="text-sm font-bold text-white">Comentários</h3>
                                    <span className="text-xs text-slate-500">({comments.length})</span>
                                </div>
                            )}
                            <button 
                                onClick={() => setIsExpanded(!isExpanded)}
                                className="ml-auto text-slate-400 hover:text-white transition-colors p-1"
                            >
                                <Icon name={isExpanded ? "chevron-right" : "chevron-left"} className="w-4 h-4"/>
                            </button>
                        </div>
                        
                        {isExpanded && (
                            <>
                                {/* Comments List */}
                                <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                    {loadingComments ? (
                                        <div className="text-center text-slate-500 text-xs py-8">Carregando...</div>
                                    ) : comments.length === 0 ? (
                                        <div className="text-center text-slate-600 text-xs py-8">
                                            <Icon name="message-square" className="w-8 h-8 mx-auto mb-2 text-slate-700"/>
                                            <p>Nenhum comentário</p>
                                            <p className="text-[10px] mt-1">Seja o primeiro!</p>
                                        </div>
                                    ) : (
                                        comments.map(cmt => (
                                            <div key={cmt.id} className="bg-slate-900/60 border border-slate-800 rounded-lg p-2.5 animate-enter">
                                                <div className="flex items-start justify-between mb-1.5">
                                                    <div className="flex items-center gap-1.5">
                                                        <div className={`w-5 h-5 ${cmt.authorColor || 'bg-slate-600'} rounded-full flex items-center justify-center text-[8px] font-bold text-white`}>
                                                            {cmt.authorAvatar || '??'}
                                                        </div>
                                                        <div>
                                                            <span className="text-[11px] font-bold text-slate-200 block leading-tight">{cmt.authorName}</span>
                                                            <span className="text-[9px] text-slate-600">
                                                                {cmt.createdAt ? new Date(cmt.createdAt).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }) : ''}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    {cmt.authorId === currentUser.id && (
                                                        <button onClick={() => deleteComment(cmt.id)} className="text-slate-600 hover:text-red-400 transition-colors p-0.5">
                                                            <Icon name="trash-2" className="w-3 h-3"/>
                                                        </button>
                                                    )}
                                                </div>
                                                <p className="text-xs text-slate-300 leading-relaxed whitespace-pre-wrap">{cmt.content}</p>
                                            </div>
                                        ))
                                    )}
                                </div>
                                
                                {/* Add Comment Button & Input */}
                                <div className="p-3 border-t border-slate-700 bg-slate-900/30">
                                    <div className="flex gap-2 items-start">
                                        <div className={`w-6 h-6 ${currentUser.color} rounded-full flex items-center justify-center text-[9px] font-bold text-white shrink-0 mt-1`}>
                                            {currentUser.avatar}
                                        </div>
                                        <div className="flex-1">
                                            <textarea 
                                                rows="2" 
                                                className="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-xs text-white placeholder-slate-600 focus:border-blue-500 focus:outline-none resize-none"
                                                placeholder="Adicionar comentário..."
                                                value={newComment}
                                                onChange={e => setNewComment(e.target.value)}
                                                onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addComment(); } }}
                                            />
                                            <button 
                                                onClick={addComment} 
                                                disabled={!newComment.trim()}
                                                className={`mt-2 w-full py-1.5 rounded-lg text-xs font-bold flex items-center justify-center gap-1.5 transition-all ${newComment.trim() ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}`}
                                            >
                                                <Icon name="plus" className="w-3.5 h-3.5"/>
                                                Adicionar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE MODAL DE TAREFA ---
        const PRIORITY_OPTIONS = [
            { value: 'low', label: 'Baixa', color: 'bg-slate-500/10 text-slate-400 border-slate-500/20', icon: 'minus' },
            { value: 'normal', label: 'Normal', color: 'bg-blue-500/10 text-blue-400 border-blue-500/20', icon: 'equal' },
            { value: 'high', label: 'Alta', color: 'bg-orange-500/10 text-orange-400 border-orange-500/20', icon: 'chevron-up' },
            { value: 'urgent', label: 'Urgente', color: 'bg-red-500/10 text-red-400 border-red-500/20', icon: 'alert-triangle' },
        ];

        const TaskModal = ({ task, isOpen, onClose, onSave, isReadOnly, currentUser, targetUserId }) => {
            const [title, setTitle] = React.useState("");
            const [desc, setDesc] = React.useState("");
            const [link, setLink] = React.useState("");
            const [priority, setPriority] = React.useState("normal");
            const [dueDate, setDueDate] = React.useState("");
            const [createdDate, setCreatedDate] = React.useState("");
            const [comments, setComments] = React.useState([]);
            const [newComment, setNewComment] = React.useState("");
            const [loadingComments, setLoadingComments] = React.useState(false);
            const [showComments, setShowComments] = React.useState(false);

            const getTodayStr = () => {
                const t = new Date();
                return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
            };

            // Load comments when task opens
            React.useEffect(() => {
                if (isOpen && task && task.id) {
                    setLoadingComments(true);
                    setShowComments(false);
                    const unsub = db.collection('drx_task_comments')
                        .where('taskId', '==', task.id)
                        .orderBy('createdAt', 'asc')
                        .onSnapshot(snap => {
                            const cmts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            setComments(cmts);
                            setLoadingComments(false);
                            if (cmts.length > 0) setShowComments(true);
                        }, err => {
                            console.error('Erro ao carregar comentários:', err);
                            setLoadingComments(false);
                        });
                    return () => unsub();
                } else {
                    setComments([]);
                    setNewComment("");
                    setShowComments(false);
                }
            }, [isOpen, task?.id]);

            React.useEffect(() => {
                if (isOpen && task) {
                    setTitle(task.text || "");
                    setDesc(task.description || "");
                    setLink(task.link || "");
                    setPriority(task.priority || "normal");
                    setDueDate(task.dueDate || "");
                    setCreatedDate(task.createdDate || getTodayStr());
                } else {
                    setTitle(""); setDesc(""); setLink(""); setPriority("normal"); setDueDate("");
                    setCreatedDate(getTodayStr());
                }
            }, [isOpen, task]);

            const addComment = async () => {
                if (!newComment.trim() || !task?.id) return;
                try {
                    await db.collection('drx_task_comments').add({
                        taskId: task.id,
                        authorId: currentUser.id,
                        authorName: currentUser.name,
                        authorAvatar: currentUser.avatar,
                        authorColor: currentUser.color,
                        content: newComment.trim(),
                        createdAt: Date.now(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Marcar tarefa como tendo comentário não lido
                    await db.collection('drx_tasks').doc(task.id).update({
                        hasUnreadComments: true,
                        lastCommentAt: Date.now()
                    });
                    
                    setNewComment("");
                } catch (err) {
                    console.error('Erro ao adicionar comentário:', err);
                    alert('Erro ao salvar comentário.');
                }
            };

            const deleteComment = async (commentId) => {
                try {
                    await db.collection('drx_task_comments').doc(commentId).delete();
                } catch (err) {
                    console.error('Erro ao deletar comentário:', err);
                }
            };

            if (!isOpen) return null;

            const isMyTask = task ? task.assignedTo === currentUser.id : targetUserId === currentUser.id;
            const canEdit = !isReadOnly || TASK_EDITORS.includes(currentUser.id) || isMyTask;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ 
                    ...task, 
                    text: title, 
                    description: desc, 
                    link: link,
                    priority: priority,
                    dueDate: dueDate || null,
                    createdDate: createdDate || getTodayStr()
                });
                onClose();
            };

            return (
                <>
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter">
                    <div className="bg-[#0f172a] border border-slate-700 w-full max-w-lg rounded-xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 sticky top-0 z-10">
                            <h3 className="text-white font-bold flex items-center gap-2">
                                <Icon name={task?.id ? "pencil" : "plus-circle"} className="w-4 h-4 text-blue-500"/> 
                                {task?.id ? "Editar Tarefa" : "Nova Tarefa"}
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon name="x" className="w-5 h-5"/></button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Título da Tarefa</label>
                                <input type="text" required disabled={!canEdit} className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-white focus:border-blue-500 focus:outline-none" placeholder="O que precisa ser feito?" value={title} onChange={e => setTitle(e.target.value)} />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Descrição Detalhada</label>
                                <textarea rows="3" disabled={!canEdit} className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-slate-300 text-sm focus:border-blue-500 focus:outline-none resize-none" placeholder="Detalhes, contexto, instruções..." value={desc} onChange={e => setDesc(e.target.value)} />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Prioridade</label>
                                <div className="grid grid-cols-4 gap-1.5">
                                    {PRIORITY_OPTIONS.map(opt => (
                                        <button key={opt.value} type="button" disabled={!canEdit} onClick={() => setPriority(opt.value)}
                                            className={`flex items-center gap-1 px-2 py-2 rounded-lg border text-xs font-bold transition-all ${priority === opt.value ? opt.color + ' border-current ring-1 ring-current/30' : 'bg-slate-950 border-slate-800 text-slate-500 hover:border-slate-600'}`}>
                                            <Icon name={opt.icon} className="w-3 h-3" />
                                            {opt.label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-1">
                                        <Icon name="calendar-plus" className="w-3 h-3" /> Data de Criação
                                    </label>
                                    <input type="date" disabled={!canEdit} className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-white focus:border-blue-500 focus:outline-none text-sm" value={createdDate} onChange={e => setCreatedDate(e.target.value)} />
                                    <div className="mt-1 text-[10px] text-slate-600">Dia em que a tarefa foi registrada</div>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-1">
                                        <Icon name="calendar-clock" className="w-3 h-3" /> Prazo de Entrega
                                    </label>
                                    <input type="date" disabled={!canEdit} className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-white focus:border-blue-500 focus:outline-none text-sm" value={dueDate} onChange={e => setDueDate(e.target.value)} />
                                    {dueDate && (() => {
                                        const today = new Date(); today.setHours(0,0,0,0);
                                        const due = new Date(dueDate + 'T00:00:00');
                                        const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                                        const isOverdue = diffDays < 0;
                                        const isToday = diffDays === 0;
                                        const isSoon = diffDays > 0 && diffDays <= 2;
                                        return (
                                            <div className={`mt-1.5 text-[10px] font-bold flex items-center gap-1 ${isOverdue ? 'text-red-400' : isToday ? 'text-yellow-400' : isSoon ? 'text-orange-400' : 'text-slate-500'}`}>
                                                <Icon name={isOverdue ? 'alert-circle' : 'clock'} className="w-3 h-3" />
                                                {isOverdue ? `Atrasada (${Math.abs(diffDays)}d)` : isToday ? 'Vence hoje!' : `${diffDays} dia(s) restante(s)`}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Link (Drive/Docs/Design)</label>
                                <div className="flex items-center gap-2 bg-slate-950 border border-slate-800 rounded p-2">
                                    <Icon name="link" className="w-4 h-4 text-slate-500"/>
                                    <input type="url" disabled={!canEdit} className="flex-1 bg-transparent text-blue-400 text-sm focus:outline-none placeholder-slate-600" placeholder="https://..." value={link} onChange={e => setLink(e.target.value)} />
                                </div>
                            </div>

                            {canEdit ? (
                                <div className="pt-4 flex justify-end gap-3">
                                    <button type="button" onClick={onClose} className="px-4 py-2 text-slate-400 text-sm font-bold hover:text-white transition-colors">Cancelar</button>
                                    <button type="submit" className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 transition-all flex items-center gap-2"><Icon name="save" className="w-4 h-4"/> Salvar</button>
                                </div>
                            ) : (
                                <div className="p-3 bg-red-900/20 border border-red-900/50 rounded text-red-400 text-xs text-center">Somente Arthur, Danillo ou o dono podem editar.</div>
                            )}
                        </form>


                    </div>
                </div>
                
                {/* Floating Comments Panel */}
                {task?.id && (
                    <FloatingCommentsPanel 
                        taskId={task.id}
                        comments={comments}
                        loadingComments={loadingComments}
                        newComment={newComment}
                        setNewComment={setNewComment}
                        addComment={addComment}
                        deleteComment={deleteComment}
                        currentUser={currentUser}
                    />
                )}
                </>
            );
        };

        // 1. TELA DAILY (RESTAURADA)
        const DailyView = () => {
            return (
                <div className="h-full flex flex-col animate-enter overflow-y-auto pr-2 pb-4">
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold text-white mb-2 flex items-center gap-2">
                            <Icon name="mic" className="w-6 h-6 text-purple-500" />
                            Rituais e Comunicação
                        </h2>
                        <p className="text-slate-400 text-sm">Diretrizes oficiais para Daily e Weekly.</p>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* DAILY SECTION */}
                        <div className="space-y-6">
                            <div className="glass-panel p-6 rounded-xl border-l-4 border-purple-500">
                                <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                    <Icon name="sun" className="w-5 h-5 text-purple-400"/> Daily (15 min)
                                </h3>
                                <div className="space-y-4">
                                    {DAILY_CONTENT.structure.map((item, idx) => (
                                        <div key={idx} className="p-3 bg-slate-900/50 rounded-lg border border-slate-800">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-blue-400 text-sm">{item.role}</span>
                                                <span className="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">{item.time}</span>
                                            </div>
                                            <ul className="list-disc list-inside text-xs text-slate-300 space-y-1">
                                                {item.what.map((w, i) => <li key={i}>{w}</li>)}
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="glass-panel p-4 rounded-xl">
                                    <h4 className="text-xs font-bold text-green-400 uppercase mb-2 flex items-center gap-1"><Icon name="check" className="w-3 h-3"/> Regras de Ouro</h4>
                                    <ul className="text-xs text-slate-400 space-y-2">
                                        {DAILY_CONTENT.rules.map((r, i) => <li key={i}>• {r}</li>)}
                                    </ul>
                                </div>
                                <div className="glass-panel p-4 rounded-xl border border-red-900/30">
                                    <h4 className="text-xs font-bold text-red-400 uppercase mb-2 flex items-center gap-1"><Icon name="ban" className="w-3 h-3"/> Proibido na Daily</h4>
                                    <ul className="text-xs text-slate-400 space-y-2">
                                        {DAILY_CONTENT.forbidden.map((r, i) => <li key={i}>• {r}</li>)}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        {/* WEEKLY SECTION */}
                        <div className="space-y-6">
                            <div className="glass-panel p-6 rounded-xl border-l-4 border-yellow-500">
                                <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                    <Icon name="calendar-check" className="w-5 h-5 text-yellow-400"/> Weekly (Sexta-feira)
                                </h3>
                                <div className="space-y-4">
                                    {WEEKLY_CONTENT.structure.map((item, idx) => (
                                        <div key={idx} className="p-3 bg-slate-900/50 rounded-lg border border-slate-800 relative overflow-hidden">
                                            <div className="flex justify-between items-center mb-2 relative z-10">
                                                <span className="font-bold text-white text-sm">{item.topic}</span>
                                                <span className="text-[10px] text-slate-500">{item.owner}</span>
                                            </div>
                                            <ul className="list-disc list-inside text-xs text-slate-400 space-y-1 relative z-10">
                                                {item.details.map((d, i) => <li key={i}>{d}</li>)}
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="glass-panel p-4 rounded-xl">
                                <h4 className="text-xs font-bold text-slate-300 uppercase mb-3">Outputs Obrigatórios</h4>
                                <div className="flex flex-wrap gap-2">
                                    {WEEKLY_CONTENT.outputs.map((o, i) => (
                                        <span key={i} className="px-2 py-1 bg-slate-800 rounded text-[10px] text-slate-400 border border-slate-700">{o}</span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DirectorInbox = ({ messages, onReply }) => {
            const openMessages = messages.filter(m => m.status === 'open');
            const [replyText, setReplyText] = React.useState("");
            const [activeMsgId, setActiveMsgId] = React.useState(null);

            return (
                <div className="flex-1 overflow-hidden bg-[#0b1121] rounded-xl border border-slate-800 p-3 flex flex-col">
                    <h3 className="text-white font-bold text-sm mb-3 flex items-center gap-2"><Icon name="inbox" className="w-4 h-4 text-yellow-500" /> Chamados ({openMessages.length})</h3>
                    <div className="flex-1 overflow-y-auto space-y-3">
                        {openMessages.length === 0 ? <div className="text-center text-slate-600 py-10">Nenhum chamado pendente.</div> : openMessages.map(msg => (
                            <div key={msg.id} className="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                                <div className="flex justify-between items-start mb-2">
                                    <div className="flex items-center gap-2"><span className="font-bold text-blue-400 text-sm capitalize">{msg.fromUser.name}</span><span className="text-[10px] text-slate-500">{msg.displayTime}</span></div>
                                </div>
                                <p className="text-slate-300 text-sm mb-3 bg-slate-800 p-2 rounded">{msg.content}</p>
                                {activeMsgId === msg.id ? (
                                    <div className="flex gap-2"><input type="text" className="flex-1 bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white" placeholder="Sua resposta..." value={replyText} onChange={(e) => setReplyText(e.target.value)} /><button onClick={() => { onReply(msg.id, replyText); setReplyText(""); setActiveMsgId(null); }} className="bg-green-600 px-3 rounded text-white text-xs font-bold hover:bg-green-500">Enviar</button><button onClick={() => setActiveMsgId(null)} className="text-slate-500 px-2"><Icon name="x" className="w-4 h-4"/></button></div>
                                ) : (
                                    <button onClick={() => setActiveMsgId(msg.id)} className="text-xs text-blue-500 hover:text-blue-400 font-bold flex items-center gap-1"><Icon name="reply" className="w-3 h-3"/> Responder</button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const GodView = ({ currentUser, globalTasks, messages, onSaveTask, onMoveTask, onBulkAction, onReply }) => {
            const [selectedMemberId, setSelectedMemberId] = React.useState(null);
            const [viewMode, setViewMode] = React.useState('supervision');
            const [inboxOpen, setInboxOpen] = React.useState(false);
            
            const allMembers = TEAM_DATA.filter(m => m.id !== currentUser.id);
            const selectedTasks = (selectedMemberId && globalTasks[selectedMemberId]) ? globalTasks[selectedMemberId] : { todo: [], doing: [], done: [] };
            const canEdit = TASK_EDITORS.includes(currentUser.id);
            const openMsgCount = messages.filter(m => m.status === 'open').length;

            return (
                <div className="h-full flex flex-col animate-enter overflow-hidden">
                    {/* Top bar: mode toggle + inbox toggle */}
                    <div className="flex items-center justify-between mb-3 flex-shrink-0">
                        <div className="bg-slate-900/50 p-1 rounded-lg border border-slate-800 flex">
                            <button onClick={() => setViewMode('supervision')} className={`px-3 py-1.5 rounded-md text-[11px] font-bold flex items-center gap-1.5 transition-all ${viewMode === 'supervision' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Icon name="layout-grid" className="w-3.5 h-3.5"/> Visão Geral</button>
                            <button onClick={() => setViewMode('personal')} className={`px-3 py-1.5 rounded-md text-[11px] font-bold flex items-center gap-1.5 transition-all ${viewMode === 'personal' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Icon name="list-todo" className="w-3.5 h-3.5"/> Meu Workflow</button>
                        </div>
                        {viewMode === 'supervision' && (
                            <button onClick={() => setInboxOpen(!inboxOpen)} className={`px-3 py-1.5 rounded-lg text-[11px] font-bold flex items-center gap-1.5 border transition-all ${inboxOpen ? 'bg-yellow-600/20 border-yellow-600/40 text-yellow-400' : 'bg-slate-900/50 border-slate-800 text-slate-400 hover:text-white'}`}>
                                <Icon name="inbox" className="w-3.5 h-3.5" />
                                Chamados
                                {openMsgCount > 0 && <span className="bg-yellow-500 text-black text-[9px] font-black px-1.5 py-0.5 rounded-full min-w-[18px] text-center">{openMsgCount}</span>}
                            </button>
                        )}
                    </div>

                    {viewMode === 'supervision' ? (
                        <>
                            {/* Members: compact horizontal scroll strip */}
                            <div className="flex gap-1.5 mb-3 overflow-x-auto pb-1 flex-shrink-0 godview-members-strip">
                                {allMembers.map(member => {
                                    const stats = globalTasks[member.id] || { todo: [], doing: [], done: [] };
                                    const doingCount = stats.doing.length;
                                    const totalTasks = stats.todo.length + stats.doing.length + stats.done.length;
                                    const donePercent = totalTasks > 0 ? Math.round((stats.done.length / totalTasks) * 100) : 0;
                                    const isSelected = selectedMemberId === member.id;
                                    const pendingMsg = messages.some(m => m.fromUser.id === member.id && m.status === 'open');
                                    const firstName = member.name.split(' ')[0];
                                    return (
                                        <button key={member.id} onClick={() => setSelectedMemberId(member.id)} className={`flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg border text-left transition-all relative shrink-0 ${isSelected ? 'border-blue-500 bg-blue-900/20' : 'border-slate-800 bg-slate-900/30 hover:bg-slate-800'}`}>
                                            {pendingMsg && <span className="absolute -top-0.5 -right-0.5 w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>}
                                            <div className={`w-6 h-6 ${member.color} rounded-full flex items-center justify-center text-[9px] font-bold text-white shrink-0`}>{member.avatar}</div>
                                            <div className="min-w-0">
                                                <div className="text-[11px] font-bold text-slate-200 whitespace-nowrap">{firstName}</div>
                                                <div className="flex items-center gap-1.5">
                                                    {doingCount > 0 && <span className="text-[9px] font-bold text-blue-400">{doingCount} ativo</span>}
                                                    <span className="text-[9px] text-slate-600">{donePercent}%</span>
                                                </div>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>

                            {/* Main area: Kanban (full) + Inbox (slide panel) */}
                            <div className="flex-1 flex gap-3 overflow-hidden min-h-0 godview-main-flex">
                                {/* Kanban takes all available space */}
                                <div className="flex-1 bg-[#0b1121] rounded-xl border border-slate-800 p-3 overflow-hidden flex flex-col relative godview-kanban-panel">
                                    {selectedMemberId ? (
                                        <>
                                            <div className="mb-2 flex items-center gap-2 pb-2 border-b border-slate-800/50 relative z-10">
                                                <div className={`w-6 h-6 ${TEAM_DATA.find(m => m.id === selectedMemberId).color} rounded-full flex items-center justify-center text-[10px] font-bold text-white`}>{TEAM_DATA.find(m => m.id === selectedMemberId).avatar}</div>
                                                <div className="min-w-0 flex-1">
                                                    <h3 className="text-sm font-bold text-white name-truncate">Quadro de {TEAM_DATA.find(m => m.id === selectedMemberId).name.split(' ')[0]}</h3>
                                                    <p className="text-[9px] text-slate-400 name-truncate">{TEAM_DATA.find(m => m.id === selectedMemberId).role}</p>
                                                </div>
                                            </div>
                                            <div className="flex-1 overflow-hidden relative z-10">
                                                <KanbanBoard 
                                                    tasks={selectedTasks} 
                                                    readOnly={!canEdit} 
                                                    onSaveTask={(task) => onSaveTask(task, selectedMemberId)} 
                                                    onMoveTask={(taskId, status, dir) => onMoveTask(selectedMemberId, taskId, status, dir)} 
                                                    onBulkAction={onBulkAction} 
                                                    currentUser={currentUser}
                                                    targetUserId={selectedMemberId}
                                                />
                                            </div>
                                        </>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-600"><Icon name="mouse-pointer-click" className="w-10 h-10 mb-2 opacity-50" /><p className="text-xs">Selecione um colaborador acima.</p></div>
                                    )}
                                </div>

                                {/* Inbox: collapsible side panel */}
                                {inboxOpen && (
                                    <div className="w-[320px] shrink-0 flex flex-col h-full overflow-hidden godview-inbox-panel animate-enter">
                                        <DirectorInbox messages={messages} onReply={onReply} />
                                    </div>
                                )}
                            </div>
                        </>
                    ) : (
                        <div className="flex-1 overflow-hidden bg-slate-900/30 rounded-xl border border-slate-800 p-3">
                            <div className="flex justify-between items-center mb-3 px-1">
                                <div className="flex items-center gap-2"><div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div><h2 className="text-sm font-bold text-slate-300 uppercase tracking-wide">Minhas Demandas</h2></div>
                                <span className="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded border border-slate-700">Diretoria</span>
                            </div>
                            <KanbanBoard 
                                tasks={globalTasks[currentUser.id] || {todo:[], doing:[], done:[]}} 
                                onMoveTask={(taskId, currentStatus, dir) => onMoveTask(currentUser.id, taskId, currentStatus, dir)} 
                                onSaveTask={(task) => onSaveTask(task, currentUser.id)} 
                                onBulkAction={onBulkAction} 
                                currentUser={currentUser}
                                targetUserId={currentUser.id}
                            />
                        </div>
                    )}
                </div>
            );
        };

        const KanbanColumn = ({ title, status, items, totalItems, color, icon, readOnly, onAddClick, onTaskClick, isSelectMode, selectedTasks, onSelectTask, onMoveTask, isFiltered }) => {
            return (
                <div className="flex-1 min-w-[220px] bg-[#0b1121] border border-slate-800 rounded-xl flex flex-col h-full">
                    <div className={`p-3 border-b border-slate-800 ${color} bg-slate-900/50`}>
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-2 font-bold text-slate-200 text-sm"><Icon name={icon} className="w-3.5 h-3.5 opacity-70" />{title}</div>
                            <span className="bg-slate-800 px-2 py-0.5 rounded text-[10px] text-slate-400 font-mono">{isFiltered ? `${items.length}/${totalItems}` : items.length}</span>
                        </div>
                    </div>
                    <div className="p-2 space-y-2 flex-1 overflow-y-auto custom-scrollbar">
                        {!readOnly && status === 'todo' && (
                            <button onClick={() => onAddClick(status)} className="w-full py-3 border-2 border-dashed border-slate-800 rounded-lg text-slate-500 hover:border-blue-500 hover:text-blue-400 transition-all text-xs font-bold flex items-center justify-center gap-2 mb-2 group">
                                <Icon name="plus" className="w-4 h-4 group-hover:scale-110 transition-transform" /> Adicionar Tarefa
                            </button>
                        )}
                        {items.map(task => (
                            <div key={task.id} className={`task-card bg-[#151e32] p-3 rounded border relative group hover:border-slate-600 transition-all ${selectedTasks.includes(task.id) ? 'border-blue-500 ring-1 ring-blue-500' : 'border-slate-700/50'}`}>
                                {isSelectMode && !readOnly && <div className="absolute top-2 right-2 z-10"><input type="checkbox" className="w-4 h-4 cursor-pointer" checked={selectedTasks.includes(task.id)} onChange={() => onSelectTask(task.id)} /></div>}
                                
                                <div onClick={() => onTaskClick(task)} className="cursor-pointer">
                                    <div className="flex justify-between items-start mb-2 pr-6">
                                        {(() => {
                                            const p = task.priority || 'normal';
                                            const map = {
                                                low: { label: 'Baixa', cls: 'bg-slate-500/10 text-slate-400 border border-slate-500/20' },
                                                normal: { label: 'Normal', cls: 'bg-blue-500/10 text-blue-400 border border-blue-500/20' },
                                                high: { label: 'Alta', cls: 'bg-orange-500/10 text-orange-400 border border-orange-500/20' },
                                                urgent: { label: 'Urgente', cls: 'bg-red-500/10 text-red-400 border border-red-500/20' },
                                            };
                                            const info = map[p] || map.normal;
                                            return <span className={`text-[9px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider ${info.cls}`}>{info.label}</span>;
                                        })()}
                                        {task.link && <Icon name="link" className="w-3 h-3 text-blue-400" />}
                                        {task.hasUnreadComments && (
                                            <span className="flex items-center gap-1 bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full text-[9px] font-bold animate-pulse">
                                                <Icon name="message-circle" className="w-3 h-3" />
                                                Novo
                                            </span>
                                        )}
                                        <CommentCountBadge taskId={task.id} />
                                    </div>
                                    <p className="text-sm text-slate-200 leading-snug font-medium mb-1">{task.text}</p>
                                    {task.description && <p className="text-[10px] text-slate-500 line-clamp-2">{task.description}</p>}
                                    <div className="mt-2 space-y-1 text-[10px]">
                                        <div className="flex justify-between items-center">
                                            {task.dueDate ? (() => {
                                                const today = new Date(); today.setHours(0,0,0,0);
                                                const due = new Date(task.dueDate + 'T00:00:00');
                                                const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                                                const isOverdue = diffDays < 0;
                                                const isToday = diffDays === 0;
                                                const isSoon = diffDays > 0 && diffDays <= 2;
                                                const formatted = due.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                                                return (
                                                    <span className={`flex items-center gap-1 font-bold ${isOverdue ? 'text-red-400' : isToday ? 'text-yellow-400' : isSoon ? 'text-orange-400' : 'text-slate-500'}`}>
                                                        <Icon name="calendar-clock" className="w-3 h-3" /> {formatted}
                                                        {isOverdue && <span className="text-red-500">!</span>}
                                                    </span>
                                                );
                                            })() : <span></span>}
                                            {task.createdDate ? (
                                                <span className="text-slate-600 flex items-center gap-1">
                                                    <Icon name="calendar-plus" className="w-3 h-3" />
                                                    {new Date(task.createdDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}
                                                </span>
                                            ) : (
                                                <span className="text-slate-600">{formatDate(task.timestamp)}</span>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {!readOnly && !isSelectMode && (
                                    <div className="flex justify-end gap-1 mt-2 pt-2 border-t border-slate-700/30">
                                        {status !== 'todo' && <button onClick={(e) => {e.stopPropagation(); onMoveTask(task.id, status, 'prev')}} className="p-1 hover:bg-slate-700 rounded text-slate-500 hover:text-white transition-colors"><Icon name="chevron-left" className="w-3 h-3" /></button>}
                                        {status !== 'done' && <button onClick={(e) => {e.stopPropagation(); onMoveTask(task.id, status, 'next')}} className="p-1 hover:bg-slate-700 rounded text-slate-500 hover:text-green-400 transition-colors"><Icon name="chevron-right" className="w-3 h-3" /></button>}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function KanbanBoard({ tasks, onMoveTask, onSaveTask, onBulkAction, readOnly = false, currentUser, targetUserId }) {
            const [isSelectMode, setIsSelectMode] = React.useState(false);
            const [selectedTasks, setSelectedTasks] = React.useState([]);
            const [modalOpen, setModalOpen] = React.useState(false);
            const [currentTask, setCurrentTask] = React.useState(null);
            const [activeFilter, setActiveFilter] = React.useState('');
            const [pendingDate, setPendingDate] = React.useState('');

            const handleSelectTask = (taskId) => setSelectedTasks(prev => prev.includes(taskId) ? prev.filter(id => id !== taskId) : [...prev, taskId]);
            const toggleSelectMode = () => { setIsSelectMode(!isSelectMode); setSelectedTasks([]); };
            
            const openNewTaskModal = () => { setCurrentTask(null); setModalOpen(true); };
            const openEditTaskModal = async (task) => { 
                setCurrentTask(task); 
                setModalOpen(true); 
                
                // Marcar comentários como lidos ao abrir a tarefa
                if (task.hasUnreadComments) {
                    try {
                        await db.collection('drx_tasks').doc(task.id).update({
                            hasUnreadComments: false
                        });
                    } catch (err) {
                        console.error('Erro ao marcar comentários como lidos:', err);
                    }
                }
            };

            const executeBulkAction = async (action) => { await onBulkAction(action, selectedTasks); setSelectedTasks([]); setIsSelectMode(false); };

            const toDateStr = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${dd}`;
            };

            const formatDateLabel = (dateStr) => {
                if (!dateStr) return '';
                const d = new Date(dateStr + 'T00:00:00');
                const today = new Date(); today.setHours(0,0,0,0);
                const diff = Math.round((d - today) / (1000*60*60*24));
                const weekday = d.toLocaleDateString('pt-BR', { weekday: 'long' });
                const formatted = d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
                let label = '';
                if (diff === 0) label = 'Hoje';
                else if (diff === 1) label = 'Amanhã';
                else if (diff === -1) label = 'Ontem';
                else label = weekday.charAt(0).toUpperCase() + weekday.slice(1);
                return { label, formatted };
            };

            const shiftDate = (direction) => {
                const base = pendingDate ? new Date(pendingDate + 'T00:00:00') : new Date();
                base.setDate(base.getDate() + direction);
                setPendingDate(toDateStr(base));
            };

            const goToToday = () => {
                const todayStr = toDateStr(new Date());
                setPendingDate(todayStr);
                setActiveFilter(todayStr);
            };

            const confirmFilter = () => {
                if (pendingDate) setActiveFilter(pendingDate);
            };

            const clearFilter = () => {
                setActiveFilter('');
                setPendingDate('');
            };

            const filterByDate = (items) => {
                if (!activeFilter) return items;
                return items.filter(task => {
                    // Match by createdDate OR dueDate
                    const matchCreated = task.createdDate === activeFilter;
                    const matchDue = task.dueDate === activeFilter;
                    return matchCreated || matchDue;
                });
            };

            const isFiltered = !!activeFilter;
            const hasPending = !!pendingDate;
            const pendingInfo = pendingDate ? formatDateLabel(pendingDate) : null;
            const activeInfo = activeFilter ? formatDateLabel(activeFilter) : null;
            const pendingDiffers = pendingDate !== activeFilter;

            return (
                <div className="flex flex-col h-full relative">
                    <TaskModal 
                        isOpen={modalOpen} onClose={() => setModalOpen(false)} 
                        task={currentTask} onSave={onSaveTask} isReadOnly={readOnly} 
                        currentUser={currentUser} targetUserId={targetUserId}
                    />

                    {/* Date navigator + actions bar */}
                    <div className="flex flex-wrap justify-between items-center mb-2 px-1 gap-2">
                        <div className="flex gap-2 items-center flex-wrap">
                            {/* Date navigator */}
                            <div className="flex items-center gap-1 bg-slate-900/80 border border-slate-700/50 rounded-lg px-1 py-0.5">
                                <button onClick={() => shiftDate(-1)} className="p-1.5 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors" title="Dia anterior">
                                    <Icon name="chevron-left" className="w-4 h-4" />
                                </button>
                                {hasPending ? (
                                    <div className="text-center px-2 min-w-[140px]">
                                        <div className="text-xs font-bold text-white leading-tight">{pendingInfo.label}</div>
                                        <div className="text-[9px] text-slate-400 leading-tight">{pendingInfo.formatted}</div>
                                    </div>
                                ) : (
                                    <button onClick={goToToday} className="text-center px-2 min-w-[140px] hover:bg-slate-800 rounded py-1 transition-colors">
                                        <div className="text-[11px] text-slate-400">Todas as datas</div>
                                        <div className="text-[9px] text-blue-400">Clique para filtrar</div>
                                    </button>
                                )}
                                <button onClick={() => shiftDate(1)} className="p-1.5 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors" title="Próximo dia">
                                    <Icon name="chevron-right" className="w-4 h-4" />
                                </button>
                            </div>
                            {/* Confirm button */}
                            {hasPending && pendingDiffers && (
                                <button onClick={confirmFilter} className="bg-green-900/30 text-green-400 px-3 py-1.5 rounded-lg text-[11px] font-bold border border-green-900/50 hover:bg-green-900/50 flex items-center gap-1 transition-all animate-enter">
                                    <Icon name="check" className="w-3.5 h-3.5"/> Confirmar
                                </button>
                            )}
                            {/* Active filter indicator */}
                            {isFiltered && (
                                <div className="flex items-center gap-1.5">
                                    <span className="text-[10px] text-emerald-400 font-bold bg-emerald-900/20 border border-emerald-900/40 px-2 py-1 rounded flex items-center gap-1">
                                        <Icon name="filter" className="w-3 h-3"/> Filtrando: {activeInfo.label}
                                    </span>
                                    <button onClick={clearFilter} className="bg-yellow-900/30 text-yellow-400 px-2.5 py-1 rounded text-[10px] font-bold border border-yellow-900/50 hover:bg-yellow-900/50 flex items-center gap-1 transition-colors">
                                        <Icon name="filter-x" className="w-3 h-3"/> Ver tudo
                                    </button>
                                </div>
                            )}
                            {!isFiltered && !hasPending && (
                                <button onClick={goToToday} className="bg-blue-900/20 text-blue-400 px-2.5 py-1 rounded text-[10px] font-bold border border-blue-900/40 hover:bg-blue-900/40 flex items-center gap-1 transition-colors">
                                    <Icon name="calendar" className="w-3 h-3"/> Hoje
                                </button>
                            )}
                            {isSelectMode && selectedTasks.length > 0 && (
                                <>
                                    <button onClick={() => executeBulkAction('delete')} className="bg-red-900/30 text-red-400 px-3 py-1 rounded text-xs font-bold border border-red-900/50 hover:bg-red-900/50 flex items-center gap-1"><Icon name="trash-2" className="w-3 h-3"/> Excluir ({selectedTasks.length})</button>
                                    <button onClick={() => executeBulkAction('duplicate')} className="bg-blue-900/30 text-blue-400 px-3 py-1 rounded text-xs font-bold border border-blue-900/50 hover:bg-blue-900/50 flex items-center gap-1"><Icon name="copy" className="w-3 h-3"/> Duplicar ({selectedTasks.length})</button>
                                </>
                            )}
                        </div>
                        {!readOnly && (
                            <div className="flex gap-2">
                                <button onClick={() => window.open('https://meet.google.com/new', '_blank')} className="px-3 py-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded text-xs font-bold flex items-center gap-1 hover:brightness-110 shadow-lg shadow-purple-900/20">
                                    <Icon name="video" className="w-3 h-3" /> Meet Rápido
                                </button>
                                <button onClick={toggleSelectMode} className={`px-3 py-1 rounded text-xs font-bold flex items-center gap-1 transition-all ${isSelectMode ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-white'}`}><Icon name={isSelectMode ? "x" : "pencil"} className="w-3 h-3" /> {isSelectMode ? "Cancelar" : "Gerenciar"}</button>
                            </div>
                        )}
                    </div>
                    <div className="flex gap-2 h-full overflow-x-auto pb-2 kanban-columns">
                        <KanbanColumn title="A FAZER" status="todo" items={filterByDate(tasks.todo)} totalItems={tasks.todo.length} color="border-t-2 border-t-slate-500" icon="circle" readOnly={readOnly} onAddClick={openNewTaskModal} onTaskClick={openEditTaskModal} isSelectMode={isSelectMode} selectedTasks={selectedTasks} onSelectTask={handleSelectTask} onMoveTask={onMoveTask} isFiltered={isFiltered} />
                        <KanbanColumn title="FAZENDO" status="doing" items={filterByDate(tasks.doing)} totalItems={tasks.doing.length} color="border-t-2 border-t-blue-500" icon="loader" readOnly={readOnly} onAddClick={() => {}} onTaskClick={openEditTaskModal} isSelectMode={isSelectMode} selectedTasks={selectedTasks} onSelectTask={handleSelectTask} onMoveTask={onMoveTask} isFiltered={isFiltered} />
                        <KanbanColumn title="FEITO" status="done" items={filterByDate(tasks.done)} totalItems={tasks.done.length} color="border-t-2 border-t-emerald-500" icon="check-circle" readOnly={readOnly} onAddClick={() => {}} onTaskClick={openEditTaskModal} isSelectMode={isSelectMode} selectedTasks={selectedTasks} onSelectTask={handleSelectTask} onMoveTask={onMoveTask} isFiltered={isFiltered} />
                    </div>
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [selectedUser, setSelectedUser] = React.useState(null);
            const [username, setUsername] = React.useState("");
            const [password, setPassword] = React.useState("");
            const [error, setError] = React.useState("");
            const boardMembers = TEAM_DATA.filter(m => m.category === 'board');
            const teamMembers = TEAM_DATA.filter(m => m.category === 'team');
            const handleCardClick = (member) => { setSelectedUser(member); setError(""); setUsername(""); setPassword(""); };
            const handleAuth = (e) => { e.preventDefault(); if (username === selectedUser.user && password === selectedUser.pass) { onLogin(selectedUser); } else { setError("Credenciais inválidas."); } };
            const Card = ({ member }) => (
                <button onClick={() => handleCardClick(member)} className="glass-panel p-3 rounded-xl hover:bg-slate-800/80 transition-all group text-left flex items-center gap-2.5 relative overflow-hidden w-full login-card-inner"><div className={`w-10 h-10 ${member.color} rounded-full flex items-center justify-center text-sm font-bold text-white shadow-lg shrink-0 login-avatar`}>{member.avatar}</div><div className="min-w-0 flex-1"><h3 className="font-bold text-slate-100 text-xs group-hover:text-blue-400 transition-colors name-truncate login-name">{member.name}</h3><p className="text-[9px] text-slate-400 uppercase font-semibold name-truncate login-role">{member.role}</p></div>{member.isDirector && <div className="absolute top-1.5 right-1.5"><Icon name="eye" className="w-3.5 h-3.5 text-blue-500" /></div>}</button>
            );
            if (selectedUser) {
                return (
                    <div className="min-h-screen bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-[#020617] p-4 md:p-8 flex flex-col items-center justify-center"><div className="max-w-md w-full glass-panel p-8 rounded-2xl border border-slate-700 animate-enter"><button onClick={() => setSelectedUser(null)} className="mb-6 flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm"><Icon name="arrow-left" className="w-4 h-4"/> Voltar</button><div className="text-center mb-8"><div className={`w-20 h-20 ${selectedUser.color} rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-lg mx-auto mb-4`}>{selectedUser.avatar}</div><h2 className="text-2xl font-bold text-white">{selectedUser.name}</h2><p className="text-slate-400 text-sm">{selectedUser.role}</p></div><form onSubmit={handleAuth} className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Login</label><input type="text" autoComplete="off" autoCapitalize="none" autoCorrect="off" spellCheck="false" className="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none" value={username} onChange={(e) => setUsername(e.target.value)} placeholder={`Ex: ${selectedUser.user}`} /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Senha</label><input type="password" autoComplete="off" className="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Sua senha..." /></div>{error && <div className="p-3 bg-red-900/20 border border-red-900/50 rounded-lg text-red-400 text-xs text-center font-medium">{error}<div className="mt-1 text-[10px] text-red-400/70">Login: {selectedUser.user} | Senha: DRX2026@</div></div>}<button type="submit" className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold transition-colors shadow-lg shadow-blue-900/20">Acessar Painel</button></form></div></div>
                );
            }
            return (
                <div className="min-h-screen bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-[#020617] p-4 md:p-8 flex flex-col items-center overflow-y-auto login-wrapper">
                    <div className="max-w-5xl w-full animate-enter py-8">
                        <div className="text-center mb-10">
                            <div className="inline-flex items-center gap-3 mb-4">
                                <div className="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg overflow-hidden"><img src="/logo-drx-white.png" alt="DRX" className="w-full h-full object-contain" /></div>
                                <div className="text-left">
                                    <h1 className="text-2xl md:text-4xl font-bold text-white tracking-tight login-title">DRX Flow</h1>
                                    <p className="text-[10px] text-slate-500 uppercase tracking-widest">Sistema Operacional</p>
                                </div>
                            </div>
                            <p className="text-slate-400 text-sm">Selecione seu perfil para acessar o workspace</p>
                        </div>
                        <div className="mb-8">
                            <h2 className="text-xs font-bold text-blue-400 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2 flex items-center gap-2">
                                <Icon name="crown" className="w-3.5 h-3.5"/> Diretoria & Estratégia
                            </h2>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 login-board-grid">
                                {boardMembers.map(m => <Card key={m.id} member={m} />)}
                            </div>
                        </div>
                        <div>
                            <h2 className="text-xs font-bold text-emerald-400 uppercase tracking-widest mb-4 border-b border-slate-800 pb-2 flex items-center gap-2">
                                <Icon name="users" className="w-3.5 h-3.5"/> Time Tático & Operacional
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 login-team-grid">
                                {teamMembers.map(m => <Card key={m.id} member={m} />)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function DailyPrepScreen({ user, onComplete, onBack }) {
            const [checks, setChecks] = React.useState({});
            const myChecklist = CHECKLISTS[user.id] || CHECKLISTS['default'];
            const myDetails = ROLE_DETAILS[user.id];
            const handleCheck = (index) => setChecks(prev => ({ ...prev, [index]: !prev[index] }));
            const allChecked = myChecklist.every((_, i) => checks[i]);
            return (
                <div className="min-h-screen bg-[#020617] p-4 md:p-8 flex flex-col overflow-y-auto">
                    <div className="flex items-center justify-between mb-6 flex-wrap gap-4">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white hover:bg-slate-700 transition-colors"><Icon name="arrow-left" className="w-5 h-5" /></button>
                            <div><h2 className="text-xl font-bold text-white">{user.name}</h2><p className="text-slate-400 text-sm">{user.role}</p></div>
                        </div>
                        <Clock />
                    </div>
                    <div className="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto w-full prep-grid">
                        <div className="lg:col-span-2 space-y-6 overflow-y-auto pr-2 pb-10 prep-details" style={{maxHeight: 'calc(100vh - 120px)'}}>
                            {myDetails ? (<>
                                <div className="glass-panel p-6 rounded-xl border-l-4 border-blue-500"><h3 className="text-lg font-bold text-white mb-2 flex items-center gap-2"><Icon name="target" className="w-5 h-5 text-blue-500"/> Missão da Função</h3><p className="text-slate-300 leading-relaxed">{myDetails.mission}</p></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="glass-panel p-5 rounded-xl role-section"><h4><Icon name="shield-alert" className="w-4 h-4"/> Não Negociáveis</h4><ul>{myDetails.nonNegotiables.map((item, i) => <li key={i}>{item}</li>)}</ul></div>
                                    <div className="glass-panel p-5 rounded-xl role-section"><h4><Icon name="ban" className="w-4 h-4 text-red-400"/> Limites Claros</h4><ul>{myDetails.limits.map((item, i) => <li key={i}>{item}</li>)}</ul></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="glass-panel p-5 rounded-xl role-section"><h4><Icon name="check-circle-2" className="w-4 h-4 text-green-400"/> Decisões Permitidas</h4><ul>{myDetails.decisions.map((item, i) => <li key={i}>{item}</li>)}</ul></div>
                                    <div className="glass-panel p-5 rounded-xl role-section"><h4><Icon name="user-check" className="w-4 h-4 text-purple-400"/> Expectativa de Comportamento</h4><ul>{myDetails.behavior.map((item, i) => <li key={i}>{item}</li>)}</ul></div>
                                </div>
                            </>) : (<div className="text-center text-slate-500 py-10">Carregando detalhes do cargo...</div>)}
                        </div>
                        <div className="lg:col-span-1">
                            <div className="glass-panel p-6 rounded-xl border border-slate-700 lg:sticky lg:top-4">
                                <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Icon name="list-checks" className="w-5 h-5 text-green-400"/> Ritual de Preparação</h3>
                                <div className="space-y-3 mb-6">
                                    {myChecklist.map((item, index) => (
                                        <label key={index} className="flex items-start gap-3 cursor-pointer p-3 rounded-lg hover:bg-slate-800/50 transition-colors custom-checkbox group border border-transparent hover:border-slate-700">
                                            <div className="relative pt-0.5"><input type="checkbox" className="hidden" checked={!!checks[index]} onChange={() => handleCheck(index)} /><div className="w-5 h-5 rounded border border-slate-500 flex items-center justify-center transition-all group-hover:border-blue-500 shrink-0"><Icon name="check" className="w-3.5 h-3.5 text-white hidden" /></div></div>
                                            <span className={`text-sm leading-snug ${checks[index] ? 'text-slate-500 line-through' : 'text-slate-200'}`}>{item}</span>
                                        </label>
                                    ))}
                                </div>
                                <button onClick={onComplete} disabled={!allChecked} className={`w-full py-4 rounded-lg font-bold flex items-center justify-center gap-2 transition-all ${allChecked ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}>
                                    {allChecked ? <><Icon name="arrow-right" className="w-5 h-5"/> Acessar Workspace</> : "Complete para Desbloquear"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- TUTORIAL COMPONENT ---
        function PainelTutorial({ onClose, isSupervisor, setActiveTab }) {
            const [step, setStep] = React.useState(0);
            const [offset, setOffset] = React.useState({ x: 0, y: 0 });
            const dragging = React.useRef(false);
            const dragStart = React.useRef({ x: 0, y: 0, ox: 0, oy: 0 });

            const steps = [
                { title: '👋 Bem-vindo ao DRX Flow!', tip: 'Tour rápido pelo sistema operacional. Arraste este card se tampar algo.', pos: 'center', arrow: 'none' },
                { title: '📋 Workflow', tip: 'Aba principal. Seu Kanban com as tarefas do dia.', pos: 'top-left', arrow: 'up', action: () => setActiveTab('workflow') },
                { title: '📌 Kanban: 3 Colunas', tip: 'A FAZER → FAZENDO → FEITO.\nAs tarefas fluem da esquerda pra direita.', pos: 'top-center', arrow: 'down' },
                { title: '➕ Criar Tarefa', tip: 'Clique em "+ Adicionar Tarefa" na coluna A FAZER.\nPreencha título, descrição e link.', pos: 'top-left', arrow: 'down' },
                { title: '◀ ▶ Mover Tarefa', tip: 'Use as setas que aparecem embaixo de cada tarefa para avançar ou voltar o status.', pos: 'top-center', arrow: 'down' },
                { title: '✏️ Gerenciar', tip: 'Clique em "Gerenciar" para selecionar tarefas e deletar ou duplicar em lote.', pos: 'top-right', arrow: 'down' },
                ...(isSupervisor ? [
                    { title: '👁️ Visão Geral', tip: 'Como supervisor, você vê o quadro de TODOS os membros. Clique em um avatar para abrir.', pos: 'top-center', arrow: 'down' },
                    { title: '📨 Chamados', tip: 'No painel lateral, responda mensagens da equipe em tempo real.', pos: 'top-right', arrow: 'left' },
                ] : [
                    { title: '📨 Inbox', tip: 'Envie mensagens para a diretoria. Veja respostas aqui.', pos: 'top-left', arrow: 'up', action: () => setActiveTab('inbox') },
                    { title: '💬 Mensagem Rápida', tip: 'Use o campo no rodapé para enviar alertas rápidos à diretoria.', pos: 'bottom-center', arrow: 'down' },
                ]),
                { title: '☀️ Daily', tip: 'Estrutura das reuniões diárias e semanais. Regras, papéis e outputs.', pos: 'top-left', arrow: 'up', action: () => setActiveTab('daily') },
                { title: '💬 Discord', tip: 'No canto inferior direito, acesse o Discord da equipe direto pelo site para comunicação em tempo real.', pos: 'bottom-right', arrow: 'down' },
                { title: '🎓 Detalhes do Cargo', tip: 'Após o login, a tela de Preparação mostra:\n• Missão do cargo\n• Não-negociáveis\n• Limites\n• Checklist diário', pos: 'center', arrow: 'none' },
                { title: '🎉 Tutorial Concluído!', tip: 'Você domina o DRX Flow!\nReabra a qualquer momento pelo botão Tutorial no cabeçalho.', pos: 'center', arrow: 'none' },
            ];

            const cur = steps[step];

            React.useEffect(() => { setOffset({ x: 0, y: 0 }); if (cur.action) cur.action(); }, [step]);

            const posStyles = {
                'center': { top: '50%', left: '50%', transform: `translate(calc(-50% + ${offset.x}px), calc(-50% + ${offset.y}px))` },
                'top-left': { top: `${80 + offset.y}px`, left: `${280 + offset.x}px` },
                'top-center': { top: `${80 + offset.y}px`, left: `calc(50% + ${offset.x}px)`, transform: 'translateX(-50%)' },
                'top-right': { top: `${80 + offset.y}px`, right: `${24 - offset.x}px` },
                'bottom-center': { bottom: `${80 - offset.y}px`, left: `calc(50% + ${offset.x}px)`, transform: 'translateX(-50%)' },
                'bottom-right': { bottom: `${100 - offset.y}px`, right: `${24 - offset.x}px` },
            };

            const handlePointerDown = (e) => {
                if (e.target.closest('button')) return;
                dragging.current = true;
                dragStart.current = { x: e.clientX, y: e.clientY, ox: offset.x, oy: offset.y };
                e.currentTarget.setPointerCapture(e.pointerId);
            };
            const handlePointerMove = (e) => {
                if (!dragging.current) return;
                setOffset({ x: dragStart.current.ox + (e.clientX - dragStart.current.x), y: dragStart.current.oy + (e.clientY - dragStart.current.y) });
            };
            const handlePointerUp = () => { dragging.current = false; };

            const next = () => step < steps.length - 1 ? setStep(step + 1) : onClose();
            const prev = () => step > 0 && setStep(step - 1);

            return (
                <>
                    <div className="tut-overlay"></div>
                    <div className="tut-card" style={posStyles[cur.pos] || posStyles['center']} onPointerDown={handlePointerDown} onPointerMove={handlePointerMove} onPointerUp={handlePointerUp}>
                        {cur.arrow !== 'none' && (
                            <div style={{ position: 'absolute', ...(cur.arrow === 'up' ? { top: '-28px', left: '20px' } : cur.arrow === 'down' ? { bottom: '-28px', left: '50%', transform: 'translateX(-50%)' } : cur.arrow === 'left' ? { left: '-28px', top: '50%', transform: 'translateY(-50%)' } : { right: '-28px', top: '50%', transform: 'translateY(-50%)' }) }}>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={cur.arrow === 'down' || cur.arrow === 'up' ? 'tut-arrow tut-arrow-down' : 'tut-arrow'}>
                                    {cur.arrow === 'up' && <><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></>}
                                    {cur.arrow === 'down' && <><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></>}
                                    {cur.arrow === 'left' && <><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>}
                                    {cur.arrow === 'right' && <><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>}
                                </svg>
                            </div>
                        )}
                        <button onClick={onClose} style={{ position: 'absolute', top: 8, right: 8, background: 'none', border: 'none', color: '#64748b', cursor: 'pointer', padding: 4 }}><Icon name="x" className="w-3.5 h-3.5"/></button>
                        <h3 style={{ fontSize: '14px', fontWeight: 700, color: '#f1f5f9', marginBottom: 4 }}>{cur.title}</h3>
                        <p style={{ fontSize: '11px', color: '#94a3b8', lineHeight: 1.5, whiteSpace: 'pre-line' }}>{cur.tip}</p>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginTop: 12, paddingTop: 8, borderTop: '1px solid rgba(255,255,255,0.06)' }}>
                            <div style={{ display: 'flex', gap: 3 }}>
                                {steps.map((_, i) => <div key={i} className={`tut-dot ${i === step ? 'active' : i < step ? 'done' : ''}`}></div>)}
                            </div>
                            <div style={{ display: 'flex', gap: 4, alignItems: 'center' }}>
                                {step > 0 && <button onClick={prev} style={{ background: 'none', border: 'none', color: '#64748b', cursor: 'pointer', padding: '2px 6px' }}><Icon name="chevron-left" className="w-4 h-4"/></button>}
                                <button onClick={next} style={{ background: '#3b82f6', border: 'none', color: 'white', padding: '4px 12px', borderRadius: 6, fontSize: 11, fontWeight: 700, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 4 }}>
                                    {step === steps.length - 1 ? 'Concluir ✅' : 'Próximo'} {step < steps.length - 1 && <Icon name="chevron-right" className="w-3 h-3"/>}
                                </button>
                            </div>
                        </div>
                    </div>
                </>
            );
        }

        // --- 5. APP CONTROLLER ---
        function App() {
            const [view, setView] = React.useState('login');
            // USE SESSIONSTORAGE FOR AUTH
            const [currentUser, setCurrentUser] = React.useState(() => {
                try {
                    const savedUser = sessionStorage.getItem('drx_user');
                    return savedUser ? JSON.parse(savedUser) : null;
                } catch (e) {
                    console.error("Auth Error", e);
                    return null;
                }
            });
            
            const [globalTasks, setGlobalTasks] = React.useState({});
            const [messages, setMessages] = React.useState([]);
            const [inputText, setInputText] = React.useState("");
            const [showPainelTutorial, setShowPainelTutorial] = React.useState(false);
            
            const [activeTab, setActiveTab] = React.useState('workflow');

            // Listener de Tarefas
            React.useEffect(() => {
                const unsubscribe = db.collection('drx_tasks').onSnapshot(snapshot => {
                    const newTasks = {};
                    TEAM_DATA.forEach(user => {
                        newTasks[user.id] = { todo: [], doing: [], done: [] };
                    });

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // --- CORREÇÃO DE SEGURANÇA (GHOST TASKS) ---
                        // Ignora tarefas específicas que estão bugadas no banco de dados
                        // Isso resolve o problema visual enquanto o banco não é limpo
                        if (GHOST_TASKS.includes(data.text)) {
                            return; // Pula essa iteração e não adiciona a tarefa
                        }
                        
                        // Verifica se existe assignedTo e status válido antes de adicionar
                        if (data.assignedTo && newTasks[data.assignedTo] && data.status && newTasks[data.assignedTo][data.status]) {
                            newTasks[data.assignedTo][data.status].push({ id: doc.id, ...data });
                        }
                    });
                    setGlobalTasks(newTasks);
                });
                return () => unsubscribe();
            }, []);

            // Listener de Mensagens
            React.useEffect(() => {
                let isFirstLoad = true;
                const unsubscribe = db.collection('drx_messages').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Tocar som apenas para novas mensagens (não no primeiro carregamento)
                    if (!isFirstLoad && snapshot.docChanges().some(change => change.type === 'added')) {
                        playNotificationSound('message');
                    }
                    isFirstLoad = false;
                    
                    setMessages(msgs);
                });
                return () => unsubscribe();
            }, []);

            // Efeito para Roteamento
            React.useEffect(() => {
                if (currentUser) {
                    const lastPrepDate = localStorage.getItem(`drx_last_prep_${currentUser.id}`);
                    const today = new Date().toDateString();
                    if (SUPERVISORS.includes(currentUser.id) || lastPrepDate === today) {
                        setView('workspace');
                    } else {
                        setView('prep');
                    }
                } else {
                    setView('login');
                }
            }, [currentUser]);

            // Sistema de Notificações Sonoras
            const playNotificationSound = (type = 'task') => {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    if (type === 'task') {
                        // Som suave para nova tarefa (2 tons)
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } else if (type === 'message') {
                        // Som suave para mensagem (1 tom)
                        oscillator.frequency.setValueAtTime(700, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.2);
                    }
                } catch (error) {
                    console.log('Notificação sonora não disponível:', error);
                }
            };

            // Ações Firebase (COM SAVE UNIFICADO)
            // --- VERSÃO CORRIGIDA DO saveTask ---
            const saveTask = async (taskData, targetUserId) => {
                try {
                    if (taskData.id) {
                        // CORREÇÃO AQUI:
                        // Usamos .set com merge: true.
                        // Isso resolve o erro "No document to update".
                        // Se a tarefa sumiu do banco, ela será recriada automaticamente aqui.
                        
                        // 1. Separamos o ID dos dados para não salvar o ID dentro do documento
                        const { id, ...dataToSave } = taskData;

                        // 2. Garantimos que só salvamos campos definidos (limpeza de segurança)
                        // Mas mantemos status, prioridade e assignedTo caso precisemos recriar a tarefa
                        const getTodayStr = () => {
                            const t = new Date();
                            return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
                        };

                        const safeData = {
                            text: dataToSave.text,
                            description: dataToSave.description || "",
                            link: dataToSave.link || "",
                            status: dataToSave.status || 'todo',
                            priority: dataToSave.priority || 'normal',
                            dueDate: dataToSave.dueDate || null,
                            createdDate: dataToSave.createdDate || getTodayStr(),
                            assignedTo: dataToSave.assignedTo || targetUserId,
                        };

                        await db.collection('drx_tasks').doc(id).set(safeData, { merge: true });

                    } else {
                        const getTodayStr = () => {
                            const t = new Date();
                            return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
                        };

                        await db.collection('drx_tasks').add({
                            text: taskData.text,
                            description: taskData.description || "",
                            link: taskData.link || "",
                            status: 'todo',
                            priority: taskData.priority || 'normal',
                            dueDate: taskData.dueDate || null,
                            createdDate: taskData.createdDate || getTodayStr(),
                            assignedTo: targetUserId || currentUser.id,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Tocar som de notificação quando criar nova tarefa
                        playNotificationSound('task');
                    }
                } catch (error) {
                    console.error("Erro ao salvar tarefa:", error);
                    alert("Houve um erro de conexão, mas tentamos corrigir. Atualize a página se persistir.");
                }
            };

            const moveTask = async (userId, taskId, currentStatus, direction) => {
                try {
                    let newStatus;
                    if (direction === 'next') { if (currentStatus === 'todo') newStatus = 'doing'; else if (currentStatus === 'doing') newStatus = 'done'; }
                    else { if (currentStatus === 'done') newStatus = 'doing'; else if (currentStatus === 'doing') newStatus = 'todo'; }
                    
                    if (newStatus) { 
                        await db.collection('drx_tasks').doc(taskId).update({ status: newStatus }); 
                    }
                } catch (error) {
                    console.error("Erro ao mover tarefa (provavelmente excluída):", error);
                }
            };

            // DUPLICAÇÃO CORRIGIDA AQUI
            const bulkAction = async (action, taskIds) => {
                if (action === 'delete') {
                    const batch = db.batch();
                    taskIds.forEach(id => {
                        const ref = db.collection('drx_tasks').doc(id);
                        batch.delete(ref);
                    });
                    await batch.commit();
                } else if (action === 'duplicate') {
                    // IMPLEMENTAÇÃO REAL DA DUPLICAÇÃO
                    const batch = db.batch();
                    for (const id of taskIds) {
                        const docRef = db.collection('drx_tasks').doc(id);
                        const doc = await docRef.get();
                        if (doc.exists) {
                            const data = doc.data();
                            const newDocRef = db.collection('drx_tasks').doc();
                            batch.set(newDocRef, {
                                ...data,
                                text: data.text + " (Cópia)",
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                    await batch.commit();
                }
            };

            const sendMessage = async (fromUser, content) => {
                await db.collection('drx_messages').add({
                    fromUser: { id: fromUser.id, name: fromUser.name },
                    content,
                    reply: null,
                    status: 'open',
                    createdAt: Date.now(),
                    displayTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            const replyMessage = async (msgId, replyContent) => {
                try {
                    await db.collection('drx_messages').doc(msgId).update({ reply: replyContent, status: 'replied' });
                } catch (error) {
                    console.error("Erro ao responder mensagem:", error);
                }
            };

            const handleLogin = (user) => { sessionStorage.setItem('drx_user', JSON.stringify(user)); setCurrentUser(user); };
            const handleLogout = () => { sessionStorage.removeItem('drx_user'); setCurrentUser(null); setView('login'); };
            const handlePrepComplete = () => { localStorage.setItem(`drx_last_prep_${currentUser.id}`, new Date().toDateString()); setView('workspace'); }

            const isSupervisor = currentUser && SUPERVISORS.includes(currentUser.id);

            return (
                <>
                    {view === 'login' && <LoginScreen onLogin={handleLogin} />}
                    {view === 'prep' && currentUser && <DailyPrepScreen user={currentUser} onComplete={handlePrepComplete} onBack={handleLogout} />}
                    {view === 'workspace' && currentUser && (
                        <div className="flex h-screen flex-col bg-[#020617]">
                            <header className="border-b border-slate-800 bg-[#0f172a] flex items-center justify-between px-3 md:px-6 py-3 shrink-0 workspace-header">
                                <div className="flex items-center gap-3 md:gap-6">
                                    <div className="flex items-center gap-2">
                                         <div className="w-8 h-8 md:w-9 md:h-9 rounded-lg flex items-center justify-center overflow-hidden shadow-lg"><img src="/logo-drx-white.png" alt="DRX" className="w-full h-full object-contain" /></div>
                                        <div><h1 className="font-bold text-white text-sm md:text-lg tracking-tight">DRX.OS</h1><p className="text-[9px] md:text-[10px] text-slate-500 uppercase tracking-widest">Sistema Operacional</p></div>
                                    </div>
                                    <nav className="hidden md:flex items-center gap-1 bg-slate-900/50 p-1 rounded-lg border border-slate-800">
                                        <button className={`px-4 py-1.5 rounded-md text-xs font-bold flex items-center gap-2 transition-all ${activeTab === 'workflow' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`} onClick={() => setActiveTab('workflow')}><Icon name="activity" className="w-3.5 h-3.5"/> Workflow</button>
                                        {!isSupervisor && <button className={`px-4 py-1.5 rounded-md text-xs font-bold flex items-center gap-2 transition-all ${activeTab === 'inbox' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`} onClick={() => setActiveTab('inbox')}><Icon name="inbox" className="w-3.5 h-3.5"/> Inbox {messages.filter(m => m.fromUser.id === currentUser.id && m.reply).length > 0 && <span className="w-2 h-2 bg-green-500 rounded-full"></span>}</button>}
                                        <button className={`px-4 py-1.5 rounded-md text-xs font-bold flex items-center gap-2 transition-all ${activeTab === 'daily' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`} onClick={() => setActiveTab('daily')}><Icon name="sun" className="w-3.5 h-3.5"/> Daily</button>
                                    </nav>
                                    <button className="tut-btn hidden md:flex" onClick={() => setShowPainelTutorial(true)}><Icon name="book-open" className="w-3.5 h-3.5"/> Tutorial</button>
                                    <a href="https://discord.gg/lovable-dev" target="_blank" rel="noopener" className="hidden md:flex items-center gap-1.5 px-3 py-1.5 bg-[#5865F2]/20 border border-[#5865F2]/30 rounded-lg text-[#5865F2] text-xs font-bold hover:bg-[#5865F2]/30 transition-all"><Icon name="message-circle" className="w-3.5 h-3.5"/> Discord</a>
                                </div>
                                <div className="flex items-center gap-3 md:gap-6">
                                    <div className="hidden md:block"><Clock /></div>
                                    <div className="h-8 w-px bg-slate-800 hidden md:block"></div>
                                    <div className="flex items-center gap-2">
                                        <div className={`w-7 h-7 md:w-8 md:h-8 ${currentUser.color} rounded-lg flex items-center justify-center text-[10px] md:text-xs font-bold text-white shadow`}>{currentUser.avatar}</div>
                                        <button onClick={handleLogout} className="text-slate-500 hover:text-red-400 transition-colors"><Icon name="log-out" className="w-4 h-4 md:w-5 md:h-5" /></button>
                                    </div>
                                </div>
                            </header>
                            {/* Mobile Nav */}
                            <div className="workspace-mobile-nav bg-[#0f172a] border-b border-slate-800 px-2 py-2 gap-1 overflow-x-auto">
                                <button className={`px-3 py-1.5 rounded-md text-[11px] font-bold flex items-center gap-1.5 transition-all whitespace-nowrap ${activeTab === 'workflow' ? 'bg-blue-600 text-white shadow' : 'text-slate-400'}`} onClick={() => setActiveTab('workflow')}><Icon name="activity" className="w-3 h-3"/> Workflow</button>
                                {!isSupervisor && <button className={`px-3 py-1.5 rounded-md text-[11px] font-bold flex items-center gap-1.5 transition-all whitespace-nowrap ${activeTab === 'inbox' ? 'bg-blue-600 text-white shadow' : 'text-slate-400'}`} onClick={() => setActiveTab('inbox')}><Icon name="inbox" className="w-3 h-3"/> Inbox</button>}
                                <button className={`px-3 py-1.5 rounded-md text-[11px] font-bold flex items-center gap-1.5 transition-all whitespace-nowrap ${activeTab === 'daily' ? 'bg-blue-600 text-white shadow' : 'text-slate-400'}`} onClick={() => setActiveTab('daily')}><Icon name="sun" className="w-3 h-3"/> Daily</button>
                                <button className="tut-btn ml-auto" onClick={() => setShowPainelTutorial(true)}><Icon name="book-open" className="w-3 h-3"/> Tutorial</button>
                            </div>
                            
                            <main className="flex-1 overflow-auto p-3 md:p-6 relative flex flex-col">
                                {activeTab === 'daily' ? (
                                    <DailyView />
                                ) : isSupervisor ? (
                                    <GodView 
                                        currentUser={currentUser}
                                        globalTasks={globalTasks}
                                        messages={messages}
                                        onSaveTask={saveTask}
                                        onMoveTask={moveTask}
                                        onBulkAction={bulkAction}
                                        onReply={replyMessage}
                                    />
                                ) : (
                                    <div className="flex-1 flex flex-col h-full animate-enter">
                                        {activeTab === 'inbox' ? (
                                            <div className="flex-1 bg-[#0b1121] rounded-xl border border-slate-800 p-4 overflow-hidden flex flex-col inbox-main">
                                                <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Icon name="inbox" className="w-5 h-5 text-blue-500"/> Caixa de Entrada</h2>
                                                <div className="space-y-4 overflow-y-auto pr-2">
                                                    {messages.filter(m => m.fromUser.id === currentUser.id).length === 0 ? <div className="text-slate-600 text-center py-10">Sua caixa de entrada está vazia.</div> : messages.filter(m => m.fromUser.id === currentUser.id).map(msg => (
                                                        <div key={msg.id} className="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
                                                            <div className="flex justify-between mb-2"><span className="text-xs font-mono text-slate-500">{msg.displayTime}</span>{msg.reply ? <span className="text-xs bg-green-900/30 text-green-400 px-2 rounded">Respondido</span> : <span className="text-xs bg-yellow-900/30 text-yellow-400 px-2 rounded">Enviado</span>}</div>
                                                            <p className="text-slate-300 text-sm mb-4">"{msg.content}"</p>
                                                            {msg.reply && <div className="bg-blue-900/10 border-l-2 border-blue-500 p-3 rounded-r-lg"><div className="flex items-center gap-2 mb-1"><div className="w-4 h-4 bg-blue-600 rounded-full flex items-center justify-center text-[8px] font-bold text-white">AD</div><span className="text-xs font-bold text-blue-400">Danillo</span></div><p className="text-white text-sm">{msg.reply}</p></div>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : (
                                            /* WORKFLOW TAB */
                                            <>
                                                <div className="flex-1 overflow-hidden bg-slate-900/30 rounded-xl border border-slate-800 p-4 mb-4">
                                                    <div className="flex justify-between items-center mb-4 px-2">
                                                        <div className="flex items-center gap-2"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><h2 className="text-sm font-bold text-slate-300 uppercase tracking-wide">Meu Fluxo</h2></div>
                                                        <span className="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded border border-slate-700">Sprint Atual</span>
                                                    </div>
                                                    <KanbanBoard 
                                                        tasks={globalTasks[currentUser.id] || {todo:[], doing:[], done:[]}} 
                                                        onMoveTask={(taskId, currentStatus, dir) => moveTask(currentUser.id, taskId, currentStatus, dir)} 
                                                        onSaveTask={(task) => saveTask(task, currentUser.id)} 
                                                        onBulkAction={bulkAction} 
                                                        currentUser={currentUser}
                                                        targetUserId={currentUser.id}
                                                    />
                                                </div>
                                                <div className="shrink-0 bg-[#0f172a] p-1.5 rounded-xl border border-slate-700/50 flex items-center gap-3 shadow-lg footer-input transition-all">
                                                    <div className="w-10 h-10 flex items-center justify-center bg-yellow-500/10 rounded-lg text-yellow-500 shrink-0"><Icon name="alert-triangle" className="w-5 h-5"/></div>
                                                    <div className="flex-1"><input type="text" className="w-full bg-transparent text-sm text-white placeholder-slate-500 focus:outline-none h-10" placeholder="Registrar incidente, insight ou bloqueio para a diretoria..." value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && inputText.trim()) { sendMessage(currentUser, inputText); setInputText(""); } }} /></div>
                                                    <button onClick={() => { if (inputText.trim()) { sendMessage(currentUser, inputText); setInputText(""); } }} className="h-9 px-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-xs font-bold transition-colors"><Icon name="send" className="w-4 h-4"/></button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                )}
                            </main>
                            {showPainelTutorial && <PainelTutorial onClose={() => setShowPainelTutorial(false)} isSupervisor={isSupervisor} setActiveTab={setActiveTab} />}
                        </div>
                    )}
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@widgetbot/crate@3" async defer>
        new Crate({
            server: '1469439424147488953',
            channel: '1469439425195806844'
        })
    </script>
</body>
</html>