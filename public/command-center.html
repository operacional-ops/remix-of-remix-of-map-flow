<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRX | Command Center</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #050a14; color: #e2e8f0; font-family: 'Inter', system-ui, -apple-system, sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .glass-panel { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .task-card { transition: transform 0.2s, box-shadow 0.2s; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.4); z-index: 10; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* WHITEBOARD STYLES */
        .whiteboard-grid {
            background-color: #f8fafc; /* Fundo claro estilo Miro padrão, ou escuro se preferir */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }
        /* Modo Escuro para o Canvas */
        .dark .whiteboard-grid {
            background-color: #0f172a;
            background-image: radial-gradient(#334155 1px, transparent 1px);
        }

        .wb-obj {
            position: absolute;
            transition: box-shadow 0.1s;
            user-select: none;
        }
        .wb-obj:hover {
            outline: 2px solid rgba(59, 130, 246, 0.5); /* Hover azul suave */
        }
        .wb-obj.selected {
            outline: 2px solid #2563eb;
            z-index: 50;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
        }

        /* Estilos Específicos */
        .sticky-note {
            box-shadow: 2px 4px 6px rgba(0,0,0,0.1);
            font-family: 'Kalam', cursive, sans-serif; /* Fonte estilo mão se disponível, senão fallback */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            overflow: hidden;
        }
        .text-obj {
            background: transparent;
            border: 1px solid transparent;
            padding: 4px;
        }
        .text-obj:hover { border: 1px dashed #cbd5e1; }
        
        .frame-obj {
            border: 2px dashed #94a3b8;
            background: rgba(255,255,255,0.05);
            pointer-events: none; /* Deixa clicar no que está dentro */
        }
        .frame-obj .frame-label {
            position: absolute;
            top: -24px;
            left: 0;
            font-size: 12px;
            color: #94a3b8;
            font-weight: bold;
            pointer-events: auto;
        }

        /* Cursor Customizado */
        .cursor-pen { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>') 0 24, auto; }
    </style>
</head>
<body class="dark"> <!-- Forçando dark mode base -->
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDylH6geJHzs1xZBhxZ7fnBLEbeKopB9nA",
          authDomain: "calendario-post-3faec.firebaseapp.com",
          projectId: "calendario-post-3faec",
          storageBucket: "calendario-post-3faec.firebasestorage.app",
          messagingSenderId: "677302847639",
          appId: "1:677302847639:web:08370d758ab1d7ebf081d2",
          measurementId: "G-3XCRGNQQSY"
        };

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        } catch (e) {
            console.error("Erro Firebase Init:", e);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        const COLLECTION_NAME = "drx_tasks_v1";
        const EXPERTS_COLLECTION = "drx_experts_v1";
        const MINDMAP_COLLECTION = "drx_mindmaps_v1";

        // --- CONSTANTES E DADOS ---
        const VIDEO_PACKS = [
            { name: "AERONAVES", url: "https://drive.google.com/drive/folders/189oEaZQcqc5mLsWSjpXMawNmoe3lmU24?usp=drive_link", icon: "plane" },
            { name: "CARROS LUXO", url: "https://drive.google.com/drive/folders/1QL8ht2tBe6nL_2-6XFTmtJAjN9nmB4qA?usp=drive_link", icon: "car" },
            { name: "CORTES PRONTOS", url: "https://drive.google.com/drive/folders/1eoW5Ar4B4gspatezHdV2eI0G2AJEZzt4?usp=drive_link", icon: "scissors" },
            { name: "MONEY", url: "https://drive.google.com/drive/folders/1qrMxmDxS1p6FnuQDAGW1kDCmKoIlgbR6?usp=drive_link", icon: "dollar-sign" },
            { name: "FEMININO", url: "https://drive.google.com/drive/folders/18HtVEZFGxzWOQmNSRhjtElJpZfFOAZE3?usp=drive_link", icon: "user" },
            { name: "FILMES E SÉRIES", url: "https://drive.google.com/drive/folders/1lZnexU1KrY4Ev0QfVwGhfppdQbZX_CBy?usp=drive_link", icon: "film" },
            { name: "LIFESTYLE", url: "https://drive.google.com/drive/folders/1puA0S1x1hMYqiBp6TbakjvAaPzDrl0eI?usp=drive_link", icon: "coffee" },
            { name: "LIFESTYLE CASAIS", url: "https://drive.google.com/drive/folders/1VOIsOTkwojahAp1_tJ1e39cYW10rZBgB?usp=drive_link", icon: "heart" },
            { name: "MANSÕES LUXO", url: "https://drive.google.com/drive/folders/1gL58gw01ye-CnWUa_rl0RpeiGhk4Vx0q?usp=drive_link", icon: "home" },
            { name: "MAR", url: "https://drive.google.com/drive/folders/1JxzWEVNnEXSYE5DJeQD87e-D743NlaMR?usp=drive_link", icon: "anchor" },
            { name: "MOTIV. & FOCO", url: "https://drive.google.com/drive/folders/1ZDIZrdle5mLUpAOOMAbv3JJk2mhAPpFb?usp=drive_link", icon: "target" },
            { name: "MOTOCROSS", url: "https://drive.google.com/drive/folders/1KmWx3jjxK62updPjCl6ca2GiKDFfKlwA?usp=drive_link", icon: "bike" },
            { name: "MOTOS", url: "https://drive.google.com/drive/folders/1HWMSOX-wajT3AkxEZka-N4-7KqNqrHQF?usp=drive_link", icon: "zap" },
            { name: "PAISAGENS & VISTAS", url: "https://drive.google.com/drive/folders/18XfVpxZN0bxkrPvyWAX9vrXIGCsGiRyb?usp=drive_link", icon: "mountain" },
            { name: "RELÓGIOS", url: "https://drive.google.com/drive/folders/1KhblqSRwbXlB8ANs3QpXJb5-ATodYAdw?usp=drive_link", icon: "watch" },
            { name: "SNOWBOARD", url: "https://drive.google.com/drive/folders/1IqgS5b1wXrNnEWZIY_6tq4pkdcYmSUPJ?usp=drive_link", icon: "snowflake" },
            { name: "VARIADOS", url: "https://drive.google.com/drive/folders/1j_GxDwIrmdN-UBoUrPZZf_Js6EI6I7iD?usp=drive_link", icon: "grid" },
            { name: "TRECHOS DE FILMES", url: "https://drive.google.com/drive/folders/1xrH9Pz-dWUM3GaRIzrzDd40o21wlrJX_?usp=sharing", icon: "clapperboard" },
        ];

        const TEAM = {
            'bruno': { name: 'Bruno Brites', role: 'Social Media', color: 'bg-blue-600', text: 'text-blue-100', initials: 'BB' },
            'victor': { name: 'Victor Navega', role: 'Editor', color: 'bg-purple-600', text: 'text-purple-100', initials: 'VN' },
            'pedro': { name: 'Pedro Cavassis', role: 'Designer', color: 'bg-pink-600', text: 'text-pink-100', initials: 'PC' },
            'danillo': { name: 'Danillo Sousa', role: 'Head Ops', color: 'bg-green-600', text: 'text-green-100', initials: 'DS' },
            'gabriel': { name: 'Gabriel Freitas', role: 'Creator', color: 'bg-yellow-600', text: 'text-yellow-100', initials: 'GF' }
        };

        const COLUMNS = [
            { id: 'backlog', title: 'Ideia / Roteiro', color: 'border-slate-500' },
            { id: 'production', title: 'Em Produção', color: 'border-yellow-500' },
            { id: 'editing', title: 'Edição / Design', color: 'border-purple-500' },
            { id: 'review', title: 'Revisão (Ops)', color: 'border-green-500' },
            { id: 'scheduled', title: 'Agendado', color: 'border-blue-500' },
            { id: 'posted', title: 'Postado', color: 'border-slate-700' }
        ];

        const TYPES = {
            'reels': { label: 'Reels', icon: 'film', color: 'text-purple-400 border-purple-500/50 bg-purple-500/10' },
            'youtube': { label: 'YouTube', icon: 'youtube', color: 'text-red-500 border-red-500/50 bg-red-500/10' },
            'carrossel': { label: 'Carrossel', icon: 'images', color: 'text-blue-400 border-blue-500/50 bg-blue-500/10' },
            'dump': { label: 'Photo Dump', icon: 'camera', color: 'text-green-400 border-green-500/50 bg-green-500/10' },
            'teste': { label: 'Teste Criativo', icon: 'flask-conical', color: 'text-yellow-400 border-yellow-500/50 bg-yellow-500/10' }
        };

        const PAUTA_TYPES = {
            'fria': { label: 'Pauta Fria', color: 'text-blue-400', border: 'border-blue-500', bg: 'bg-blue-500' },
            'quente': { label: 'Pauta Quente', color: 'text-orange-500', border: 'border-orange-500', bg: 'bg-orange-500' },
            'urgente': { label: 'Pauta Urgente', color: 'text-red-500', border: 'border-red-600', bg: 'bg-red-600' }
        };

        const REELS_FORMATS = [
            { id: 'pov', label: 'POV (Point of View)' },
            { id: 'video_falado', label: 'Vídeo Falado / Conteúdo' },
            { id: 'caixinha', label: 'Caixinha de Perguntas' },
            { id: 'trend', label: 'Trend / Viral' }
        ];

        const DEFAULT_EXPERTS = ['Pedro Cavassis', 'Arthur César', 'Brandon Cantuária', 'DRX'];

        const getTaskType = (type) => TYPES[type] || TYPES['reels'];
        const formatDateShort = (dateStr) => dateStr ? dateStr.split('-').reverse().slice(0,2).join('/') : '--/--';

        const Icon = ({ name, className, ...props }) => {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if (ref.current && window.lucide) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.className = className;
                    ref.current.innerHTML = '';
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' });
                }
            }, [name, className]); 
            return <span ref={ref} style={{ display: 'contents' }}></span>;
        };

        // --- COMPONENTE MIND MAP EVOLUÍDO ---
        function MindMapView({ user }) {
            const [maps, setMaps] = React.useState([]);
            const [currentMap, setCurrentMap] = React.useState(null);
            
            // Dados do Mapa
            const [nodes, setNodes] = React.useState([]); // Post-its, Textos, Frames, Comentários
            const [edges, setEdges] = React.useState([]); // Linhas de conexão
            const [drawings, setDrawings] = React.useState([]); // Desenhos à mão livre
            
            const [view, setView] = React.useState({ x: 0, y: 0, scale: 1 });
            const [isDraggingCanvas, setIsDraggingCanvas] = React.useState(false);
            const [dragStart, setDragStart] = React.useState({ x: 0, y: 0 });
            
            const [selectedId, setSelectedId] = React.useState(null); // ID do objeto selecionado
            const [activeTool, setActiveTool] = React.useState('cursor'); // Ferramenta atual
            
            // Estados temporários para interações
            const [drawingPath, setDrawingPath] = React.useState(null); // Caminho sendo desenhado
            const [connectionStart, setConnectionStart] = React.useState(null); // Nó inicial da conexão
            const [isEditingText, setIsEditingText] = React.useState(null); // ID do texto sendo editado
            const [nodeDrag, setNodeDrag] = React.useState(null); // { id, startX, startY, origX, origY }
            
            const [loadingMap, setLoadingMap] = React.useState(false);

            // Carregar lista de mapas
            React.useEffect(() => {
                const unsubscribe = db.collection(MINDMAP_COLLECTION).orderBy('createdAt', 'desc').onSnapshot(snap => {
                    setMaps(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, []);

            // Salvar automaticamente (Debounce)
            React.useEffect(() => {
                if (!currentMap || loadingMap) return;
                const timer = setTimeout(() => {
                    db.collection(MINDMAP_COLLECTION).doc(currentMap.id).update({ 
                        nodes, 
                        edges, 
                        drawings, 
                        updatedAt: new Date().toISOString() 
                    });
                }, 1000);
                return () => clearTimeout(timer);
            }, [nodes, edges, drawings, currentMap]);

            // CRUD Mapas
            const createNewMap = async () => {
                const name = prompt("Nome do novo Quadro:");
                if (!name) return;
                setLoadingMap(true);
                try {
                    const newMap = {
                        name,
                        createdAt: new Date().toISOString(),
                        nodes: [],
                        edges: [],
                        drawings: []
                    };
                    const docRef = await db.collection(MINDMAP_COLLECTION).add(newMap);
                    openMap({ id: docRef.id, ...newMap });
                } catch (error) {
                    alert("Erro: " + error.message);
                } finally {
                    setLoadingMap(false);
                }
            };

            const deleteMap = async (e, mapId) => {
                e.stopPropagation();
                if (!confirm("Tem certeza que deseja EXCLUIR este quadro?")) return;
                try {
                    await db.collection(MINDMAP_COLLECTION).doc(mapId).delete();
                } catch (err) { alert("Erro ao excluir: " + err.message); }
            };

            const duplicateMap = async (e, map) => {
                e.stopPropagation();
                if (!confirm("Duplicar este quadro?")) return;
                try {
                    const { id, ...data } = map;
                    await db.collection(MINDMAP_COLLECTION).add({
                        ...data,
                        name: data.name + " (Cópia)",
                        createdAt: new Date().toISOString()
                    });
                } catch (err) { alert("Erro ao duplicar: " + err.message); }
            };

            const openMap = (map) => {
                setLoadingMap(true);
                setCurrentMap(map);
                setNodes(map.nodes || []);
                setEdges(map.edges || []);
                setDrawings(map.drawings || []);
                setView({ x: window.innerWidth / 2 - 400, y: window.innerHeight / 2 - 300, scale: 1 });
                setLoadingMap(false);
            };

            // Templates Rápidos
            const addTemplate = (type) => {
                const cx = (window.innerWidth / 2 - view.x) / view.scale;
                const cy = (window.innerHeight / 2 - view.y) / view.scale;
                
                if (type === 'kanban') {
                    const newNodes = [
                        { id: Math.random().toString(36), type: 'text', text: 'A Fazer', x: cx - 200, y: cy, fontSize: 20, color: 'transparent' },
                        { id: Math.random().toString(36), type: 'text', text: 'Fazendo', x: cx, y: cy, fontSize: 20, color: 'transparent' },
                        { id: Math.random().toString(36), type: 'text', text: 'Feito', x: cx + 200, y: cy, fontSize: 20, color: 'transparent' },
                        { id: Math.random().toString(36), type: 'sticky', text: 'Tarefa 1', x: cx - 200, y: cy + 50, color: '#fef3c7', width: 150, height: 150 },
                    ];
                    setNodes(prev => [...prev, ...newNodes]);
                } else if (type === 'matrix') {
                    // Frame Matrix
                    const frameId = Math.random().toString(36);
                    setNodes(prev => [...prev, 
                        { id: frameId, type: 'frame', text: 'Matriz Eisenhower', x: cx - 300, y: cy - 300, width: 600, height: 600 },
                        { id: Math.random().toString(36), type: 'text', text: 'Urgente', x: cx - 150, y: cy - 320, fontSize: 16 },
                        { id: Math.random().toString(36), type: 'text', text: 'Não Urgente', x: cx + 150, y: cy - 320, fontSize: 16 }
                    ]);
                    // Linhas da matriz
                    setDrawings(prev => [...prev, 
                        { id: Math.random().toString(36), points: [{x: cx, y: cy-300}, {x: cx, y: cy+300}], color: '#94a3b8', width: 2 },
                        { id: Math.random().toString(36), points: [{x: cx-300, y: cy}, {x: cx+300, y: cy}], color: '#94a3b8', width: 2 }
                    ]);
                }
            };

            // INTERAÇÕES CANVAS
            const getWorldPos = (e) => ({
                x: (e.clientX - view.x) / view.scale,
                y: (e.clientY - view.y) / view.scale
            });

            const handleMouseDown = (e) => {
                const { x, y } = getWorldPos(e);

                // 1. Ferramenta de Mover Canvas (Espaço ou Botão Direito ou apenas fundo)
                if (e.button === 2 || activeTool === 'cursor') {
                    if (!e.target.closest('.wb-obj') && !e.target.closest('.control-btn')) {
                        setIsDraggingCanvas(true);
                        setDragStart({ x: e.clientX, y: e.clientY, origViewX: view.x, origViewY: view.y });
                        return;
                    }
                }

                // 2. Ferramentas de Criação
                if (activeTool !== 'cursor') {
                    if (activeTool === 'pen') {
                        setDrawingPath({ id: Math.random().toString(36), points: [{x, y}], color: '#ef4444', width: 3 });
                    } else if (activeTool === 'line') {
                        // Inicia linha se clicou em objeto ou no vazio
                        const target = e.target.closest('.wb-obj');
                        const startId = target ? target.dataset.id : null;
                        setConnectionStart({ x, y, startId });
                    } else {
                        // Criar Objetos (Sticky, Text, Frame, Comment)
                        createObject(activeTool, x, y);
                        setActiveTool('cursor'); // Volta para cursor após criar
                    }
                    return;
                }

                // 3. Seleção e Arraste de Objetos
                const target = e.target.closest('.wb-obj');
                if (target) {
                    const id = target.dataset.id;
                    setSelectedId(id);
                    const node = nodes.find(n => n.id === id);
                    if (node && node.type !== 'line') { // Linhas não se arrastam assim
                        setNodeDrag({ id, startX: e.clientX, startY: e.clientY, origX: node.x, origY: node.y });
                    }
                    e.stopPropagation();
                } else {
                    setSelectedId(null);
                }
            };

            const handleMouseMove = (e) => {
                const { x, y } = getWorldPos(e);

                if (isDraggingCanvas) {
                    const dx = e.clientX - dragStart.x;
                    const dy = e.clientY - dragStart.y;
                    setView(prev => ({ ...prev, x: dragStart.origViewX + dx, y: dragStart.origViewY + dy }));
                }

                if (drawingPath) {
                    setDrawingPath(prev => ({ ...prev, points: [...prev.points, {x, y}] }));
                }

                if (connectionStart) {
                    // Atualiza visual da linha temporária (poderia ser state para renderizar)
                }

                if (nodeDrag) {
                    const dx = (e.clientX - nodeDrag.startX) / view.scale;
                    const dy = (e.clientY - nodeDrag.startY) / view.scale;
                    setNodes(prev => prev.map(n => 
                        n.id === nodeDrag.id ? { ...n, x: nodeDrag.origX + dx, y: nodeDrag.origY + dy } : n
                    ));
                }
            };

            const handleMouseUp = (e) => {
                const { x, y } = getWorldPos(e);

                if (drawingPath) {
                    setDrawings(prev => [...prev, drawingPath]);
                    setDrawingPath(null);
                }

                if (connectionStart) {
                    const target = e.target.closest('.wb-obj');
                    const endId = target ? target.dataset.id : null;
                    if (connectionStart.startId && endId && connectionStart.startId !== endId) {
                        // Criar conexão lógica entre objetos
                        setEdges(prev => [...prev, { id: Math.random().toString(36), from: connectionStart.startId, to: endId }]);
                    } else if (!connectionStart.startId && !endId) {
                        // Desenho livre de linha não suportado nesta versão simples, apenas obj->obj
                    }
                    setConnectionStart(null);
                    setActiveTool('cursor');
                }

                setIsDraggingCanvas(false);
                setNodeDrag(null);
            };

            const handleWheel = (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const scaleAmount = -e.deltaY * 0.001;
                    const newScale = Math.min(Math.max(0.1, view.scale + scaleAmount), 5);
                    setView(prev => ({ ...prev, scale: newScale }));
                } else {
                    setView(prev => ({ ...prev, x: prev.x - e.deltaX, y: prev.y - e.deltaY }));
                }
            };

            // Helpers
            const createObject = (type, x, y) => {
                const id = Math.random().toString(36).substr(2, 9);
                let newNode = { id, x, y, type };

                if (type === 'sticky') {
                    newNode = { ...newNode, text: '', color: '#fef3c7', width: 160, height: 160 };
                } else if (type === 'text') {
                    newNode = { ...newNode, text: 'Novo Texto', color: 'transparent', fontSize: 24, width: 200, height: 50 };
                } else if (type === 'frame') {
                    newNode = { ...newNode, text: 'Novo Frame', width: 400, height: 300, zIndex: -1 };
                } else if (type === 'comment') {
                    newNode = { ...newNode, text: 'Comentário...', width: 30, height: 30, color: '#ef4444' };
                }

                setNodes(prev => [...prev, newNode]);
                setSelectedId(id);
                if(type === 'sticky' || type === 'text') setTimeout(() => setIsEditingText(id), 50);
            };

            const deleteSelected = () => {
                if (!selectedId) return;
                setNodes(prev => prev.filter(n => n.id !== selectedId));
                setEdges(prev => prev.filter(e => e.from !== selectedId && e.to !== selectedId));
                setSelectedId(null);
            };

            // Atalhos de Teclado
            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    if (isEditingText) return;
                    if (!currentMap) return;

                    // Ferramentas
                    if (e.key.toLowerCase() === 'v') setActiveTool('cursor');
                    if (e.key.toLowerCase() === 'n') setActiveTool('sticky');
                    if (e.key.toLowerCase() === 't') setActiveTool('text');
                    if (e.key.toLowerCase() === 'l') setActiveTool('line');
                    if (e.key.toLowerCase() === 'p') setActiveTool('pen');
                    if (e.key.toLowerCase() === 'f') setActiveTool('frame');
                    if (e.key.toLowerCase() === 'c') setActiveTool('comment');

                    // Ações
                    if (e.key === 'Delete' || e.key === 'Backspace') deleteSelected();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentMap, selectedId, isEditingText]);

            // --- RENDERIZAÇÃO ---

            const renderEdges = () => {
                return edges.map(edge => {
                    const fromNode = nodes.find(n => n.id === edge.from);
                    const toNode = nodes.find(n => n.id === edge.to);
                    if (!fromNode || !toNode) return null;

                    // Centro dos objetos (aprox)
                    const startX = fromNode.x + (fromNode.width || 100)/2;
                    const startY = fromNode.y + (fromNode.height || 50)/2;
                    const endX = toNode.x + (toNode.width || 100)/2;
                    const endY = toNode.y + (toNode.height || 50)/2;

                    return (
                        <line 
                            key={edge.id}
                            x1={startX} y1={startY} x2={endX} y2={endY}
                            stroke="#64748b" strokeWidth="2"
                            markerEnd="url(#arrowhead)"
                        />
                    );
                });
            };

            const renderDrawings = () => {
                return [...drawings, drawingPath].filter(Boolean).map(d => {
                    if (d.points.length < 2) return null;
                    const pathData = `M ${d.points.map(p => `${p.x} ${p.y}`).join(' L ')}`;
                    return (
                        <path 
                            key={d.id} 
                            d={pathData} 
                            stroke={d.color} 
                            strokeWidth={d.width} 
                            fill="none" 
                            strokeLinecap="round" 
                            strokeLinejoin="round" 
                        />
                    );
                });
            };

            const renderNode = (node) => {
                const isSelected = node.id === selectedId;
                
                // --- STICKY NOTE ---
                if (node.type === 'sticky') {
                    return (
                        <div 
                            key={node.id} 
                            data-id={node.id}
                            className={`wb-obj sticky-note ${isSelected ? 'selected' : ''}`}
                            style={{ 
                                left: node.x, top: node.y, width: node.width, height: node.height, 
                                backgroundColor: node.color, transform: isSelected ? 'scale(1.02)' : 'rotate(-1deg)'
                            }}
                            onDoubleClick={() => setIsEditingText(node.id)}
                        >
                            {isEditingText === node.id ? (
                                <textarea autoFocus className="w-full h-full bg-transparent outline-none resize-none text-center" 
                                    value={node.text} onChange={e => setNodes(nodes.map(n => n.id===node.id ? {...n, text: e.target.value} : n))} 
                                    onBlur={() => setIsEditingText(null)} />
                            ) : (
                                <span className="pointer-events-none break-words w-full">{node.text || <span className="opacity-30">Digite...</span>}</span>
                            )}
                        </div>
                    );
                }

                // --- TEXTO ---
                if (node.type === 'text') {
                    return (
                        <div 
                            key={node.id} 
                            data-id={node.id}
                            className={`wb-obj text-obj ${isSelected ? 'selected' : ''}`}
                            style={{ left: node.x, top: node.y, minWidth: '100px', color: '#e2e8f0', fontSize: node.fontSize || 16 }}
                            onDoubleClick={() => setIsEditingText(node.id)}
                        >
                            {isEditingText === node.id ? (
                                <textarea autoFocus className="w-full bg-transparent outline-none resize-none" rows={1}
                                    value={node.text} onChange={e => setNodes(nodes.map(n => n.id===node.id ? {...n, text: e.target.value} : n))} 
                                    onBlur={() => setIsEditingText(null)} />
                            ) : (
                                <div className="font-bold pointer-events-none whitespace-nowrap">{node.text || "Texto"}</div>
                            )}
                        </div>
                    );
                }

                // --- FRAME ---
                if (node.type === 'frame') {
                    return (
                        <div 
                            key={node.id} 
                            data-id={node.id}
                            className={`wb-obj frame-obj ${isSelected ? 'selected' : ''}`}
                            style={{ left: node.x, top: node.y, width: node.width, height: node.height, zIndex: 0 }}
                        >
                            <div className="frame-label">{node.text}</div>
                        </div>
                    );
                }

                // --- COMENTÁRIO ---
                if (node.type === 'comment') {
                    return (
                        <div 
                            key={node.id} 
                            data-id={node.id}
                            className={`wb-obj rounded-full rounded-bl-none flex items-center justify-center shadow-lg ${isSelected ? 'selected' : ''}`}
                            style={{ left: node.x, top: node.y, width: 32, height: 32, backgroundColor: node.color, zIndex: 100 }}
                            title={node.text}
                        >
                            <Icon name="message-square" className="w-4 h-4 text-white" />
                        </div>
                    );
                }
            };

            // --- TELA DE SELEÇÃO DE MAPAS ---
            if (!currentMap) {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-white animate-in fade-in zoom-in duration-300 relative">
                        <div className="bg-slate-900/90 p-8 rounded-3xl border border-slate-700 shadow-2xl text-center max-w-4xl w-full relative overflow-hidden">
                            <h2 className="text-4xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">Meus Quadros</h2>
                            <p className="text-slate-400 mb-8">Selecione um projeto ou inicie um novo brainstorm.</p>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto p-2">
                                <button onClick={createNewMap} className="aspect-video p-6 bg-blue-600/10 border-2 border-dashed border-blue-500/30 hover:border-blue-500 hover:bg-blue-600/20 rounded-2xl flex flex-col items-center justify-center gap-3 transition-all group">
                                    <div className="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center group-hover:scale-110 transition-transform"><Icon name="plus" className="w-6 h-6 text-blue-400" /></div>
                                    <span className="font-bold text-blue-200">Novo Quadro</span>
                                </button>
                                {maps.map(map => (
                                    <div key={map.id} onClick={() => openMap(map)} className="aspect-video p-4 bg-slate-800 border border-slate-700 hover:border-slate-500 hover:bg-slate-750 rounded-2xl flex flex-col justify-between transition-all group relative cursor-pointer text-left">
                                        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                            <button onClick={(e) => duplicateMap(e, map)} className="p-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300" title="Duplicar"><Icon name="copy" className="w-3.5 h-3.5" /></button>
                                            <button onClick={(e) => deleteMap(e, map.id)} className="p-1.5 bg-red-900/50 hover:bg-red-900 rounded-lg text-red-300" title="Excluir"><Icon name="trash-2" className="w-3.5 h-3.5" /></button>
                                        </div>
                                        <div className="flex items-start gap-3">
                                            <div className="p-2 bg-slate-700/50 rounded-lg"><Icon name="trello" className="w-5 h-5 text-slate-400" /></div>
                                            <div>
                                                <h3 className="font-bold text-white leading-tight line-clamp-2">{map.name}</h3>
                                                <span className="text-[10px] text-slate-500">{formatDateShort(map.createdAt)}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 text-xs text-slate-400 bg-slate-900/50 p-2 rounded-lg w-fit">
                                            <Icon name="layers" className="w-3 h-3" /> {map.nodes?.length || 0} objetos
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // --- CANVAS PRINCIPAL ---
            return (
                <div 
                    className={`w-full h-full relative overflow-hidden whiteboard-grid ${activeTool === 'pen' ? 'cursor-pen' : (activeTool !== 'cursor' ? 'cursor-crosshair' : (isDraggingCanvas ? 'cursor-grabbing' : 'cursor-grab'))}`}
                    onMouseDown={handleMouseDown}
                    onMouseMove={handleMouseMove}
                    onMouseUp={handleMouseUp}
                    onWheel={handleWheel}
                    onContextMenu={(e) => e.preventDefault()} // Bloqueia menu nativo para usar botão direito como Pan
                >
                    {/* Toolbar Flutuante */}
                    <div className="absolute top-4 left-1/2 -translate-x-1/2 z-50 bg-slate-800/90 backdrop-blur border border-slate-600 p-1.5 rounded-xl shadow-2xl flex gap-1 items-center">
                        <button onClick={() => setActiveTool('cursor')} className={`p-2 rounded-lg transition ${activeTool==='cursor' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`} title="Selecionar (V)"><Icon name="mouse-pointer-2" className="w-5 h-5"/></button>
                        <div className="w-px h-6 bg-slate-600 mx-1"></div>
                        <button onClick={() => setActiveTool('text')} className={`p-2 rounded-lg transition ${activeTool==='text' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`} title="Texto (T)"><Icon name="type" className="w-5 h-5"/></button>
                        <button onClick={() => setActiveTool('sticky')} className={`p-2 rounded-lg transition ${activeTool==='sticky' ? 'bg-yellow-500 text-black shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`} title="Nota Adesiva (N)"><Icon name="sticky-note" className="w-5 h-5"/></button>
                        <button onClick={() => setActiveTool('frame')} className={`p-2 rounded-lg transition ${activeTool==='frame' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`} title="Frame (F)"><Icon name="layout" className="w-5 h-5"/></button>
                        <div className="w-px h-6 bg-slate-600 mx-1"></div>
                        <button onClick={() => setActiveTool('line')} className={`p-2 rounded-lg transition ${activeTool==='line' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`} title="Conector (L)"><Icon name="arrow-up-right" className="w-5 h-5"/></button>
                        <button onClick={() => setActiveTool('pen')} className={`p-2 rounded-lg transition ${activeTool==='pen' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`} title="Caneta (P)"><Icon name="pen-tool" className="w-5 h-5"/></button>
                        <button onClick={() => setActiveTool('comment')} className={`p-2 rounded-lg transition ${activeTool==='comment' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`} title="Comentário (C)"><Icon name="message-square" className="w-5 h-5"/></button>
                    </div>

                    {/* Botões Auxiliares */}
                    <div className="absolute top-4 left-4 z-50 flex gap-2">
                        <button onClick={() => setCurrentMap(null)} className="p-2 bg-slate-800 border border-slate-600 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 shadow-lg"><Icon name="arrow-left" className="w-5 h-5"/></button>
                        <div className="relative group">
                            <button className="p-2 bg-slate-800 border border-slate-600 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 shadow-lg flex items-center gap-2"><Icon name="layout-template" className="w-5 h-5"/> Templates</button>
                            <div className="absolute top-full left-0 mt-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-2 w-48 hidden group-hover:block">
                                <button onClick={() => addTemplate('kanban')} className="w-full text-left p-2 hover:bg-slate-700 rounded text-sm text-slate-300">Kanban Board</button>
                                <button onClick={() => addTemplate('matrix')} className="w-full text-left p-2 hover:bg-slate-700 rounded text-sm text-slate-300">Matriz 2x2</button>
                            </div>
                        </div>
                    </div>

                    {/* Área de Zoom/Info */}
                    <div className="absolute bottom-4 right-4 z-50 bg-slate-800/80 backdrop-blur border border-slate-700 p-2 rounded-lg text-xs text-slate-400 flex flex-col gap-1 shadow-xl">
                        <div className="font-bold text-white mb-1">{currentMap.name}</div>
                        <div>Zoom: {(view.scale * 100).toFixed(0)}%</div>
                        <div className="flex gap-2 mt-1">
                            <button onClick={()=>deleteSelected()} className="hover:text-red-400"><Icon name="trash-2" className="w-4 h-4"/></button>
                        </div>
                    </div>

                    {/* RENDERIZAÇÃO DO MUNDO */}
                    <div 
                        style={{ 
                            transform: `translate(${view.x}px, ${view.y}px) scale(${view.scale})`, 
                            transformOrigin: '0 0',
                            width: '100%', height: '100%'
                        }}
                    >
                        {/* 1. Camada de Conexões (SVG) */}
                        <svg className="absolute top-0 left-0 overflow-visible w-full h-full pointer-events-none" style={{zIndex: 0}}>
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#64748b" />
                                </marker>
                            </defs>
                            {renderEdges()}
                            {renderDrawings()}
                            {/* Linha temporária sendo criada */}
                            {connectionStart && (
                                <line x1={connectionStart.x} y1={connectionStart.y} x2={connectionStart.x} y2={connectionStart.y} stroke="#3b82f6" strokeWidth="2" strokeDasharray="5,5" />
                            )}
                        </svg>

                        {/* 2. Camada de Objetos (HTML) */}
                        {nodes.map(node => renderNode(node))}
                    </div>
                </div>
            );
        }

        // --- APP PRINCIPAL ATUALIZADO ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [tasks, setTasks] = React.useState([]);
            const [experts, setExperts] = React.useState(DEFAULT_EXPERTS);
            
            // VIEW MODE: Adicionado 'mindmap'
            const [viewMode, setViewMode] = React.useState('kanban'); 
            
            const [loading, setLoading] = React.useState(true);
            const [statusMsg, setStatusMsg] = React.useState("Iniciando...");
            const [statusColor, setStatusColor] = React.useState("text-yellow-500");
            
            // Filtros e Modais existentes
            const [filterExpert, setFilterExpert] = React.useState('');
            const [filterType, setFilterType] = React.useState('');
            const [filterPauta, setFilterPauta] = React.useState('');
            const [columnDateFilters, setColumnDateFilters] = React.useState({});
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [editingTask, setEditingTask] = React.useState(null);
            const [isPacksModalOpen, setIsPacksModalOpen] = React.useState(false);
            const [isSelectionMode, setIsSelectionMode] = React.useState(false);
            const [selectedTasks, setSelectedTasks] = React.useState(new Set());

            // ... (Efeitos e Lógica de Auth/Firestore mantidos) ...
            React.useEffect(() => {
                const timer = setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 50);
                return () => clearTimeout(timer);
            }, [tasks, viewMode, isModalOpen, isPacksModalOpen, isSelectionMode, filterExpert, filterType, filterPauta, columnDateFilters, selectedTasks]); 

            React.useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged(async (u) => {
                    if (u) { setUser(u); setStatusMsg("Conectado ao Database"); setStatusColor("text-green-400"); } 
                    else { try { await auth.signInAnonymously(); } catch (error) { console.error("Erro Auth:", error); setStatusMsg("Erro de Login"); setStatusColor("text-red-500"); } }
                });
                return () => unsubscribeAuth();
            }, []);

            React.useEffect(() => {
                const unsubscribe = db.collection(COLLECTION_NAME).onSnapshot((snapshot) => {
                    const tasksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTasks(tasksData);
                    setLoading(false);
                }, (error) => { console.error("Erro Firestore:", error); setStatusMsg("Erro de Permissão"); setStatusColor("text-red-500"); setLoading(false); });
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                const fetchExperts = async () => {
                    try {
                        const doc = await db.collection(EXPERTS_COLLECTION).doc('list').get();
                        if (doc.exists) {
                            const data = doc.data();
                            const merged = Array.from(new Set([...DEFAULT_EXPERTS, ...(data.names || [])]));
                            setExperts(merged);
                        } else {
                            await db.collection(EXPERTS_COLLECTION).doc('list').set({ names: DEFAULT_EXPERTS });
                        }
                    } catch (e) { console.error("Erro ao carregar experts", e); }
                };
                fetchExperts();
            }, []);

            // ... (Lógica de Tarefas mantida: FilteredTasks, CRUD, etc.) ...
            const baseFilteredTasks = React.useMemo(() => {
                let result = tasks.filter(task => {
                    const matchesExpert = filterExpert ? task.expert === filterExpert : true;
                    let matchesType = true;
                    if (filterType) {
                        if (filterType.startsWith('reels_')) {
                            const fmtId = filterType.replace('reels_', '');
                            matchesType = task.type === 'reels' && task.reelsFormat === fmtId;
                        } else {
                            matchesType = task.type === filterType;
                        }
                    }
                    const matchesPauta = filterPauta ? task.pauta === filterPauta : true;
                    return matchesExpert && matchesType && matchesPauta;
                });
                result.sort((a, b) => {
                    const dateA = new Date(a.updatedAt || a.createdAt || 0);
                    const dateB = new Date(b.updatedAt || b.createdAt || 0);
                    return dateB - dateA;
                });
                return result;
            }, [tasks, filterExpert, filterType, filterPauta]);

            const addNewExpertToDb = async (newExpertName) => {
                if (!newExpertName || experts.includes(newExpertName)) return;
                try {
                    const newExpertsList = [...experts, newExpertName];
                    await db.collection(EXPERTS_COLLECTION).doc('list').set({ names: newExpertsList }, { merge: true });
                    setExperts(newExpertsList);
                } catch (e) { alert("Erro ao salvar novo expert: " + e.message); }
            };

            const removeExpertFromDb = async (expertName) => {
                if (DEFAULT_EXPERTS.includes(expertName)) { alert("Experts padrão não podem ser removidos."); return; }
                if (!confirm(`Remover o expert "${expertName}"?`)) return;
                try {
                    const newList = experts.filter(e => e !== expertName);
                    await db.collection(EXPERTS_COLLECTION).doc('list').set({ names: newList }, { merge: true });
                    setExperts(newList);
                    if (filterExpert === expertName) setFilterExpert('');
                } catch (e) { alert("Erro ao remover expert: " + e.message); }
            };

            const renameExpertInDb = async (oldName) => {
                const newName = prompt(`Renomear "${oldName}" para:`, oldName);
                if (!newName || newName.trim() === '' || newName.trim() === oldName) return;
                const trimmed = newName.trim();
                if (experts.includes(trimmed)) { alert("Já existe um expert com esse nome."); return; }
                try {
                    const newList = experts.map(e => e === oldName ? trimmed : e);
                    await db.collection(EXPERTS_COLLECTION).doc('list').set({ names: newList }, { merge: true });
                    setExperts(newList);
                    if (filterExpert === oldName) setFilterExpert(trimmed);
                    // Update tasks that reference old name
                    const snapshot = await db.collection(COLLECTION_NAME).where('expert', '==', oldName).get();
                    if (!snapshot.empty) {
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.update(doc.ref, { expert: trimmed }));
                        await batch.commit();
                    }
                } catch (e) { alert("Erro ao renomear expert: " + e.message); }
            };

            const saveTask = async (taskData) => {
                try {
                    setStatusMsg("Salvando...");
                    const payload = { ...taskData, updatedAt: new Date().toISOString() };
                    if (taskData.id) await db.collection(COLLECTION_NAME).doc(taskData.id).update(payload);
                    else await db.collection(COLLECTION_NAME).add({ ...payload, createdAt: new Date().toISOString() });
                    setIsModalOpen(false); setEditingTask(null); setStatusMsg("Salvo com sucesso!"); setTimeout(() => setStatusMsg("Conectado"), 2000);
                } catch (error) { alert("Falha ao salvar: " + error.message); }
            };

            const deleteTask = async (taskId) => {
                if(!confirm("Tem certeza que deseja excluir esta tarefa?")) return;
                try { await db.collection(COLLECTION_NAME).doc(taskId).delete(); setIsModalOpen(false); } catch (error) { alert("Erro ao deletar: " + error.message); }
            };

            const updateStatus = async (taskId, newStatus) => {
                try { await db.collection(COLLECTION_NAME).doc(taskId).update({ status: newStatus, updatedAt: new Date().toISOString() }); } catch(e) { console.error(e); }
            };

            const toggleTaskSelection = (taskId) => {
                setSelectedTasks(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(taskId)) newSet.delete(taskId); else newSet.add(taskId);
                    return newSet;
                });
            };

            const toggleSelectionMode = () => { if (isSelectionMode) { setIsSelectionMode(false); setSelectedTasks(new Set()); } else { setIsSelectionMode(true); } };

            const deleteSelectedTasks = async () => {
                if (selectedTasks.size === 0) return;
                if (!confirm(`Tem certeza que deseja EXCLUIR ${selectedTasks.size} tarefas?`)) return;
                setStatusMsg("Excluindo...");
                const batch = db.batch();
                const tasksToDelete = Array.from(selectedTasks);
                tasksToDelete.forEach(taskId => { const ref = db.collection(COLLECTION_NAME).doc(taskId); batch.delete(ref); });
                try { await batch.commit(); setSelectedTasks(new Set()); setIsSelectionMode(false); setStatusMsg("Tarefas excluídas!"); setTimeout(() => setStatusMsg("Conectado"), 2000); } catch (error) { alert("Erro ao excluir: " + error.message); }
            };

            const duplicateSelectedTasks = async () => {
                if (selectedTasks.size === 0) return;
                if (!confirm(`Deseja DUPLICAR ${selectedTasks.size} tarefas?`)) return;
                setStatusMsg("Duplicando...");
                const batch = db.batch();
                const tasksToDuplicate = Array.from(selectedTasks);
                let count = 0;
                tasksToDuplicate.forEach(taskId => {
                    const originalTask = tasks.find(t => t.id === taskId);
                    if (originalTask) {
                        const newRef = db.collection(COLLECTION_NAME).doc();
                        const { id, ...data } = originalTask;
                        batch.set(newRef, { ...data, title: `${data.title} (Cópia)`, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                        count++;
                    }
                });
                if (count === 0) return;
                try { await batch.commit(); setSelectedTasks(new Set()); setIsSelectionMode(false); setStatusMsg("Tarefas duplicadas!"); setTimeout(() => setStatusMsg("Conectado"), 2000); } catch (error) { alert("Erro ao duplicar: " + error.message); }
            };
            
            const generatePlanning = async () => {
                if (!confirm("Gerar planejamento automático da semana?")) return;
                const batch = db.batch();
                const today = new Date();
                const formatDateLocal = (d) => { const offset = d.getTimezoneOffset(); return new Date(d.getTime() - (offset * 60 * 1000)).toISOString().split('T')[0]; };
                for (let i = 0; i < 7; i++) {
                    const postDate = new Date(today); postDate.setDate(today.getDate() + i); const dateStr = formatDateLocal(postDate);
                    const deadline = new Date(postDate); deadline.setDate(postDate.getDate() - 1); const deadlineStr = formatDateLocal(deadline);
                    const createTask = (title, type, assignee, time, priority) => {
                        const ref = db.collection(COLLECTION_NAME).doc();
                        batch.set(ref, { title, type, assignee, priority, status: 'backlog', date: dateStr, time, deadlineDate: deadlineStr, deadlineTime: '18:00', description: 'Gerado automaticamente pelo sistema.', updates: '', expert: 'DRX', creator: 'Sistema', reelsFormat: '', pauta: 'fria', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                    };
                    ['09:00', '11:00', '19:00'].forEach(t => createTask('Reels Rotina', 'reels', 'victor', t, 'high'));
                    createTask('Teste Criativo', 'teste', 'gabriel', '15:00', 'medium');
                }
                try { await batch.commit(); alert("Planejamento gerado!"); } catch(e) { alert("Erro ao gerar: " + e.message); }
            };

            const openNewTask = (date = null) => {
                const today = new Date().toISOString().split('T')[0];
                setEditingTask({ status: 'backlog', type: 'reels', priority: 'medium', date: date || today, time: '09:00', deadlineDate: today, deadlineTime: '18:00', assignee: 'bruno', description: '', updates: '', expert: 'DRX', creator: '', reelsFormat: '', pauta: '' });
                setIsModalOpen(true);
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-slate-900 text-white flex-col gap-4"><div className="spinner"></div><p>{statusMsg}</p></div>;

            return (
                <div className="min-h-screen pb-10 flex flex-col h-screen">
                    {/* Header - COM BOTÃO MIND MAP */}
                    <header className="glass-panel sticky top-0 z-30 px-6 py-4 flex flex-col md:flex-row justify-between items-center mb-6 border-b border-slate-700/50 gap-4 shrink-0">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center font-bold text-2xl">D</div>
                            <div>
                                <h1 className="text-xl font-bold text-white">DRX Operação</h1>
                                <div className={`text-xs font-mono flex items-center gap-2 ${statusColor}`}>
                                    <span className={`w-2 h-2 rounded-full bg-current animate-pulse`}></span>
                                    {statusMsg}
                                </div>
                            </div>
                        </div>

                        {/* NAV CENTRAL */}
                        <div className="flex bg-slate-800/80 p-1 rounded-xl border border-slate-700">
                            <button onClick={() => setViewMode('calendar')} className={`px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all ${viewMode==='calendar'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`}>
                                <Icon name="calendar" className="w-4 h-4" /> Calendário
                            </button>
                            <button onClick={() => setViewMode('kanban')} className={`px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all ${viewMode==='kanban'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`}>
                                <Icon name="kanban" className="w-4 h-4" /> Kanban
                            </button>
                            {/* NOVO BOTÃO DE MODO */}
                            <button onClick={() => setViewMode('mindmap')} className={`px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all ${viewMode==='mindmap'?'bg-cyan-600 text-white shadow-[0_0_15px_rgba(8,145,178,0.5)]':'text-slate-400 hover:text-cyan-400'}`}>
                                <Icon name="brain-circuit" className="w-4 h-4" /> Mind Map
                            </button>
                        </div>

                        {/* FERRAMENTAS (Só mostra se não estiver no MindMap para não poluir) */}
                        <div className="flex gap-3 items-center flex-wrap justify-end flex-1">
                            {viewMode !== 'mindmap' && (
                                <>
                                    <div className="flex items-center gap-2 border-r border-slate-700 pr-4 mr-2">
                                        <button onClick={() => setIsPacksModalOpen(true)} className="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg transition-transform hover:scale-105">
                                            <Icon name="package" className="w-4 h-4" /> Packs 4K
                                        </button>
                                        {/* Filtros Dropdown */}
                                        <div className="flex items-center gap-1 bg-slate-800 border border-slate-600 rounded-lg px-2 py-1.5"><Icon name="users" className="w-3 h-3 text-slate-400" /><select value={filterExpert} onChange={(e) => setFilterExpert(e.target.value)} className="bg-transparent text-xs text-slate-200 outline-none w-28 cursor-pointer"><option value="" className="bg-slate-800">Todos Experts</option>{experts.map(e => <option key={e} value={e} className="bg-slate-800">{e}</option>)}</select></div>
                                        <div className="flex items-center gap-1 bg-slate-800 border border-slate-600 rounded-lg px-2 py-1.5"><Icon name="megaphone" className="w-3 h-3 text-slate-400" /><select value={filterPauta} onChange={(e) => setFilterPauta(e.target.value)} className="bg-transparent text-xs text-slate-200 outline-none w-28 cursor-pointer"><option value="" className="bg-slate-800">Toda Pauta</option>{Object.entries(PAUTA_TYPES).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}</select></div>
                                        <div className="flex items-center gap-1 bg-slate-800 border border-slate-600 rounded-lg px-2 py-1.5"><Icon name="filter" className="w-3 h-3 text-slate-400" /><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="bg-transparent text-xs text-slate-200 outline-none w-32 cursor-pointer"><option value="" className="bg-slate-800">Todos Tipos</option>{Object.entries(TYPES).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}<optgroup label="Formato Reels" className="bg-slate-800">{REELS_FORMATS.map(fmt => <option key={'rf_'+fmt.id} value={'reels_'+fmt.id} className="bg-slate-800">{fmt.label}</option>)}</optgroup></select></div>
                                        {(filterExpert || filterType || filterPauta) && (<button onClick={() => { setFilterExpert(''); setFilterType(''); setFilterPauta(''); }} className="text-xs text-red-400 hover:text-red-300 underline" title="Limpar Filtros">Limpar</button>)}
                                    </div>

                                    {/* Ações em Massa */}
                                    {isSelectionMode ? (
                                        <div className="flex gap-2 animate-in fade-in slide-in-from-right-4 duration-300">
                                            <span className="bg-slate-700 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center">{selectedTasks.size} sel.</span>
                                            <button onClick={duplicateSelectedTasks} disabled={selectedTasks.size === 0} className="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg disabled:opacity-50"><Icon name="copy" className="w-4 h-4" /></button>
                                            <button onClick={deleteSelectedTasks} disabled={selectedTasks.size === 0} className="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg disabled:opacity-50"><Icon name="trash-2" className="w-4 h-4" /></button>
                                            <button onClick={toggleSelectionMode} className="px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg"><Icon name="x" className="w-4 h-4" /></button>
                                        </div>
                                    ) : (
                                        <button onClick={toggleSelectionMode} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600 rounded-lg text-sm font-medium flex gap-2"><Icon name="check-square" className="w-4 h-4" /> Selecionar</button>
                                    )}

                                    {!isSelectionMode && (
                                        <>
                                            <button onClick={generatePlanning} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-yellow-400 border border-yellow-500/20 rounded-lg text-sm font-medium flex gap-2"><Icon name="wand-2" className="w-4 h-4" /> <span className="hidden lg:inline">Gerar Semana</span></button>
                                            <button onClick={() => openNewTask()} className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-bold flex gap-2 shadow-lg"><Icon name="plus" className="w-4 h-4" /> <span className="hidden lg:inline">Nova</span></button>
                                        </>
                                    )}
                                </>
                            )}
                        </div>
                    </header>

                    {/* CONTEÚDO PRINCIPAL (Troca de Views) */}
                    <main className="px-6 flex-1 overflow-hidden relative">
                        {viewMode === 'mindmap' ? (
                            <MindMapView user={user} />
                        ) : (
                            <>
                                {/* AVISO DE FILTRO ATIVO */}
                                {(filterExpert || filterType || filterPauta) && (
                                    <div className="mb-4 bg-blue-900/20 border border-blue-500/30 text-blue-200 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                                        <Icon name="filter" className="w-4 h-4" />
                                        Filtrando por: 
                                        {filterExpert && <span className="font-bold bg-blue-800 px-2 rounded text-xs">{filterExpert}</span>}
                                        {filterPauta && <span className="font-bold bg-blue-800 px-2 rounded text-xs">{PAUTA_TYPES[filterPauta]?.label}</span>}
                                        {filterType && <span className="font-bold bg-blue-800 px-2 rounded text-xs">{TYPES[filterType]?.label || filterType}</span>}
                                        <span className="ml-auto text-xs opacity-70">Mostrando {baseFilteredTasks.length} tarefas</span>
                                    </div>
                                )}

                                {viewMode === 'calendar' ? 
                                    <CalendarView tasks={baseFilteredTasks} onTaskClick={(t)=>{setEditingTask(t);setIsModalOpen(true)}} onDateClick={openNewTask} /> : 
                                    <KanbanView 
                                        tasks={baseFilteredTasks} 
                                        onTaskClick={(t)=>{ if(!isSelectionMode) { setEditingTask(t); setIsModalOpen(true); } else { toggleTaskSelection(t.id); } }} 
                                        onStatusChange={updateStatus}
                                        isSelectionMode={isSelectionMode}
                                        selectedTasks={selectedTasks}
                                        toggleTaskSelection={toggleTaskSelection}
                                        columnDateFilters={columnDateFilters}
                                        setColumnDateFilters={setColumnDateFilters}
                                    />
                                }
                            </>
                        )}
                    </main>

                    {/* Modais Globais */}
                    {isPacksModalOpen && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setIsPacksModalOpen(false)}>
                            <div className="bg-slate-900 border border-slate-700 w-full max-w-4xl rounded-2xl shadow-2xl p-0 overflow-hidden max-h-[85vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b border-slate-700 bg-slate-800 flex justify-between items-center sticky top-0 z-10">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg">
                                            <Icon name="package" className="w-6 h-6 text-white" />
                                        </div>
                                        <div>
                                            <h2 className="text-xl font-bold text-white">Banco de Ativos 4K</h2>
                                            <p className="text-xs text-slate-400">30.000+ Vídeos Ultra HD para Criativos</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setIsPacksModalOpen(false)} className="text-slate-400 hover:text-white p-2 hover:bg-slate-700 rounded-lg transition"><Icon name="x" className="w-6 h-6" /></button>
                                </div>
                                <div className="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 bg-slate-900">
                                    {VIDEO_PACKS.map((pack, index) => (
                                        <a key={index} href={pack.url} target="_blank" rel="noopener noreferrer" className="group bg-slate-800 border border-slate-700 hover:border-purple-500/50 hover:bg-slate-800/80 p-4 rounded-xl flex flex-col items-center justify-center gap-3 transition-all hover:-translate-y-1 shadow-lg hover:shadow-purple-900/20 text-center">
                                            <div className="w-12 h-12 bg-slate-700/50 rounded-full flex items-center justify-center group-hover:bg-purple-500/20 group-hover:text-purple-400 transition-colors text-slate-400"><Icon name={pack.icon} className="w-6 h-6" /></div>
                                            <span className="font-bold text-sm text-slate-200 group-hover:text-white">{pack.name}</span>
                                            <span className="text-[10px] text-slate-500 bg-slate-900 px-2 py-1 rounded-full flex items-center gap-1 group-hover:text-purple-300"><Icon name="external-link" className="w-3 h-3" /> Abrir Drive</span>
                                        </a>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && <TaskModal task={editingTask} experts={experts} onAddExpert={addNewExpertToDb} onRemoveExpert={removeExpertFromDb} onRenameExpert={renameExpertInDb} onClose={()=>setIsModalOpen(false)} onSave={saveTask} onDelete={deleteTask} />}
                </div>
            );
        }

        // --- SUBCOMPONENTES ORIGINAIS (MANTIDOS) ---
        function CalendarView({ tasks, onTaskClick, onDateClick }) {
            const [currentDate, setCurrentDate] = React.useState(new Date());
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const cells = [];
            for (let i = 0; i < firstDay; i++) cells.push(<div key={`empty-${i}`} className="min-h-[100px] bg-slate-900/40 border border-slate-700/30"></div>);
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTasks = tasks.filter(t => t.date === dateStr).sort((a,b) => a.time.localeCompare(b.time));
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                cells.push(
                    <div key={day} className={`min-h-[100px] p-2 border border-slate-700/30 group hover:bg-slate-800/30 ${isToday ? 'bg-blue-900/10' : ''}`}>
                        <div className="flex justify-between mb-2">
                            <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>{day}</span>
                            <button onClick={(e)=>{e.stopPropagation();onDateClick(dateStr)}} className="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-white"><Icon name="plus" className="w-4 h-4" /></button>
                        </div>
                        <div className="flex flex-col gap-1">
                            {dayTasks.map(task => {
                                const typeData = getTaskType(task.type);
                                const pautaData = PAUTA_TYPES[task.pauta];
                                return (
                                    <div key={task.id} onClick={(e)=>{e.stopPropagation();onTaskClick(task)}} className={`text-[10px] p-1 rounded border-l-2 cursor-pointer truncate ${typeData.color} bg-opacity-10 hover:brightness-125 flex items-center gap-1`}>
                                        {pautaData && <div className={`w-1.5 h-1.5 rounded-full ${pautaData.bg}`} title={pautaData.label}></div>}
                                        <span className="truncate">{task.time} {task.title}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }
            return (
                <div className="glass-panel rounded-xl overflow-hidden h-full flex flex-col">
                    <div className="p-4 bg-slate-800/50 flex justify-between items-center shrink-0">
                        <h2 className="text-lg font-bold">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
                        <div className="flex gap-1">
                            <button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="p-2 hover:bg-slate-700 rounded"><Icon name="chevron-left" className="w-5 h-5" /></button>
                            <button onClick={()=>setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="p-2 hover:bg-slate-700 rounded"><Icon name="chevron-right" className="w-5 h-5" /></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 bg-slate-900 text-center text-xs font-bold text-slate-500 py-2 shrink-0">
                        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                    </div>
                    <div className="grid grid-cols-7 overflow-y-auto flex-1">{cells}</div>
                </div>
            );
        }

        function KanbanView({ tasks, onTaskClick, onStatusChange, isSelectionMode, selectedTasks, toggleTaskSelection, columnDateFilters, setColumnDateFilters }) {
            const [openFilterColumn, setOpenFilterColumn] = React.useState(null);
            const [filterType, setFilterType] = React.useState(null); 
            const handleDrop = (e, statusId) => { const taskId = e.dataTransfer.getData('taskId'); if (taskId) onStatusChange(taskId, statusId); };
            const toggleColumnFilter = (colId, type) => { if (openFilterColumn === colId && filterType === type) { setOpenFilterColumn(null); setFilterType(null); } else { setOpenFilterColumn(colId); setFilterType(type); } };
            const applyColumnFilter = (colId, date) => { setColumnDateFilters(prev => ({ ...prev, [colId]: { date, type: filterType } })); };
            const confirmFilter = () => { setOpenFilterColumn(null); setFilterType(null); };
            const clearColumnFilter = (colId) => { const newFilters = {...columnDateFilters}; delete newFilters[colId]; setColumnDateFilters(newFilters); };

            return (
                <div className="flex gap-4 overflow-x-auto pb-6 h-full">
                    {COLUMNS.map(col => {
                        const activeFilter = columnDateFilters[col.id]; 
                        const colTasks = tasks.filter(t => {
                            if (t.status !== col.id) return false;
                            if (activeFilter && activeFilter.date) {
                                if (activeFilter.type === 'posting') return t.date === activeFilter.date;
                                if (activeFilter.type === 'edition') return t.deadlineDate === activeFilter.date;
                            }
                            return true;
                        });
                        let borderClass = col.color;
                        if (activeFilter) {
                            if (activeFilter.type === 'edition') borderClass = 'border-green-500 shadow-[0_-4px_0_0_rgba(34,197,94,1)]';
                            if (activeFilter.type === 'posting') borderClass = 'border-purple-500 shadow-[0_-4px_0_0_rgba(168,85,247,1)]';
                        }
                        return (
                            <div key={col.id} onDragOver={e=>e.preventDefault()} onDrop={(e)=>handleDrop(e, col.id)} className={`min-w-[320px] w-[320px] flex flex-col glass-panel rounded-xl h-full border-t-4 transition-all duration-300 ${borderClass} relative`}>
                                <div className="p-3 bg-slate-800/60 rounded-t flex justify-between items-center relative">
                                    <div className="flex items-center gap-2"><span className="font-bold text-sm">{col.title}</span><span className="text-xs bg-slate-700 px-2 rounded-full text-slate-300">{colTasks.length}</span></div>
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => toggleColumnFilter(col.id, 'edition')} className={`p-1.5 rounded hover:bg-green-900/30 transition-colors ${activeFilter?.type === 'edition' ? 'text-green-400 bg-green-900/20' : 'text-slate-500 hover:text-green-400'}`} title="Prazo Edição"><Icon name="search" className="w-3.5 h-3.5" /></button>
                                        <button onClick={() => toggleColumnFilter(col.id, 'posting')} className={`p-1.5 rounded hover:bg-purple-900/30 transition-colors ${activeFilter?.type === 'posting' ? 'text-purple-400 bg-purple-900/20' : 'text-slate-500 hover:text-purple-400'}`} title="Postagem"><Icon name="search" className="w-3.5 h-3.5" /></button>
                                    </div>
                                    {openFilterColumn === col.id && (
                                        <div className="absolute top-10 right-2 z-50 bg-slate-900 border border-slate-600 p-3 rounded-lg shadow-xl w-56 animate-in fade-in zoom-in-95 duration-100">
                                            <p className={`text-[10px] uppercase font-bold mb-2 flex items-center gap-1 ${filterType === 'edition' ? 'text-green-400' : 'text-purple-400'}`}><Icon name="filter" className="w-3 h-3" />{filterType === 'edition' ? 'Prazo de Edição' : 'Data de Postagem'}</p>
                                            <input type="date" className={`w-full bg-slate-800 border rounded p-1.5 text-xs text-white mb-2 [color-scheme:dark] outline-none focus:ring-1 ${filterType === 'edition' ? 'border-green-800 focus:ring-green-500' : 'border-purple-800 focus:ring-purple-500'}`} onChange={(e) => applyColumnFilter(col.id, e.target.value)} value={activeFilter?.type === filterType ? (activeFilter?.date || '') : ''} autoFocus />
                                            <div className="flex gap-2">
                                                {activeFilter && (<button onClick={() => clearColumnFilter(col.id)} className="flex-1 bg-red-900/30 hover:bg-red-900/50 text-red-400 text-xs py-1.5 rounded flex items-center justify-center gap-1 transition-colors"><Icon name="x" className="w-3 h-3" /> Limpar</button>)}
                                                <button onClick={confirmFilter} className={`flex-1 text-white text-xs py-1.5 rounded flex items-center justify-center gap-1 transition-colors ${filterType === 'edition' ? 'bg-green-600 hover:bg-green-500' : 'bg-purple-600 hover:bg-purple-500'}`}><Icon name="check" className="w-3 h-3" /> OK</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                {activeFilter && (<div className={`px-3 py-1 text-[10px] font-bold flex justify-between items-center ${activeFilter.type === 'edition' ? 'bg-green-900/20 text-green-400' : 'bg-purple-900/20 text-purple-400'}`}><span>{activeFilter.type === 'edition' ? 'PRAZO EDIÇÃO:' : 'POSTAGEM:'} {formatDateShort(activeFilter.date)}</span><button onClick={() => clearColumnFilter(col.id)} className="hover:text-white"><Icon name="x" className="w-3 h-3" /></button></div>)}
                                <div className="p-3 flex-1 overflow-y-auto space-y-3">
                                    {colTasks.map(task => {
                                        const typeStyle = getTaskType(task.type);
                                        const assignee = TEAM[task.assignee] || {initials:'?'};
                                        const isSelected = selectedTasks.has(task.id);
                                        const pautaData = PAUTA_TYPES[task.pauta];
                                        return (
                                            <div key={task.id} draggable={!isSelectionMode} onDragStart={(e)=>e.dataTransfer.setData('taskId', task.id)} onClick={(e) => { if (isSelectionMode) { e.stopPropagation(); toggleTaskSelection(task.id); } else { onTaskClick(task); } }} className={`task-card bg-slate-800 p-3 rounded border cursor-pointer relative overflow-hidden transition-all duration-200 ${isSelected ? 'ring-2 ring-blue-500 bg-blue-900/20 border-blue-500' : 'border-slate-700'}`}>
                                                {isSelectionMode && (<div className="absolute top-2 right-2 z-20 p-2" onClick={(e) => { e.stopPropagation(); toggleTaskSelection(task.id); }}><div className={`w-5 h-5 border-2 rounded transition-colors flex items-center justify-center ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-slate-500 bg-slate-900/80 hover:border-blue-400'}`}>{isSelected && <Icon name="check" className="w-3.5 h-3.5 text-white stroke-[3]" />}</div></div>)}
                                                <div className={`absolute left-0 top-0 bottom-0 w-1 ${typeStyle.color.split(' ')[0].replace('text-','bg-')}`}></div>
                                                <div className="flex justify-between items-start mb-2 pl-2">
                                                    <div className="flex gap-1"><span className={`text-[9px] font-bold px-1 rounded border ${typeStyle.color}`}>{typeStyle.label}</span></div>
                                                    <div className="flex items-center gap-2">{pautaData && (<Icon name="megaphone" className={`w-3.5 h-3.5 ${pautaData.color}`} />)}{task.priority==='high' && <Icon name="flame" className="w-3.5 h-3.5 text-red-500 animate-pulse" />}</div>
                                                </div>
                                                <p className="text-sm font-medium pl-2 mb-1 line-clamp-2">{task.title}</p>
                                                {task.creator && (<div className="pl-2 mb-2"><span className="text-[10px] bg-slate-700/50 text-slate-400 px-1.5 py-0.5 rounded-sm flex items-center gap-1 w-fit"><Icon name="lightbulb" className="w-2.5 h-2.5 text-yellow-500" /> {task.creator}</span></div>)}
                                                {task.expert && (<div className="pl-2 mb-2"><span className="text-[9px] uppercase tracking-wider font-bold text-slate-500">{task.expert}</span></div>)}
                                                <div className="flex justify-between items-end pl-2 pt-2 border-t border-slate-700">
                                                    <div className="text-[10px] text-slate-400">
                                                        <div className="text-purple-300"><Icon name="calendar" className="inline w-3 h-3" /> Post: {formatDateShort(task.date)}</div>
                                                        <div className="text-green-300"><Icon name="clock" className="inline w-3 h-3" /> Edit: {formatDateShort(task.deadlineDate)}</div>
                                                    </div>
                                                    <div className={`w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold ${assignee.color} ${assignee.text}`}>{assignee.initials}</div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function TaskModal({ task, onClose, onSave, onDelete, experts, onAddExpert, onRemoveExpert, onRenameExpert }) {
            const [formData, setFormData] = React.useState(task || {});
            const [newExpertName, setNewExpertName] = React.useState('');
            const [showAddExpert, setShowAddExpert] = React.useState(false);
            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            const handleAddExpert = () => { if(newExpertName.trim()) { onAddExpert(newExpertName.trim()); setFormData({...formData, expert: newExpertName.trim()}); setNewExpertName(''); setShowAddExpert(false); } };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-xl shadow-2xl overflow-hidden" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between">
                            <h2 className="font-bold text-white">{task.id ? 'Editar' : 'Nova Tarefa'}</h2>
                            <button onClick={onClose}><Icon name="x" className="w-5 h-5" /></button>
                        </div>
                        <div className="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                            <div className="grid grid-cols-3 gap-4">
                                <div className="col-span-2"><label className="block text-xs font-bold text-slate-400 mb-1">TÍTULO</label><input name="title" value={formData.title||''} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white" placeholder="Ex: Reels sobre Marketing" autoFocus /></div>
                                <div><label className="block text-xs font-bold text-yellow-500 mb-1">QUEM DEU A IDEIA?</label><input name="creator" value={formData.creator||''} onChange={handleChange} className="w-full bg-slate-800 border border-yellow-500/30 rounded p-2 text-white placeholder-slate-600" placeholder="Seu nome" /></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><div className="flex justify-between items-center mb-1"><label className="text-xs font-bold text-slate-400">EXPERT</label><div className="flex gap-2"><button onClick={()=>setShowAddExpert(!showAddExpert)} className="text-[10px] text-blue-400 hover:text-blue-300 underline">+ Novo</button>{formData.expert && !['Pedro Cavassis','Arthur César','Brandon Cantuária','DRX'].includes(formData.expert) && (<><button onClick={()=>{onRenameExpert(formData.expert);}} className="text-[10px] text-yellow-400 hover:text-yellow-300 underline">Renomear</button><button onClick={()=>{onRemoveExpert(formData.expert); setFormData({...formData, expert: 'DRX'});}} className="text-[10px] text-red-400 hover:text-red-300 underline">Remover</button></>)}</div></div>{showAddExpert ? (<div className="flex gap-2 mb-2"><input value={newExpertName} onChange={e=>setNewExpertName(e.target.value)} className="flex-1 bg-slate-900 border border-blue-500 rounded p-2 text-white text-sm" placeholder="Nome" /><button onClick={handleAddExpert} className="px-2 bg-blue-600 text-white rounded font-bold text-xs">OK</button></div>) : (<select name="expert" value={formData.expert} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white">{experts.map(exp => <option key={exp} value={exp}>{exp}</option>)}</select>)}</div>
                                <div><label className="text-xs font-bold text-slate-400 block mb-1">TEMPERATURA DA PAUTA</label><select name="pauta" value={formData.pauta || ''} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"><option value="">Selecione...</option>{Object.entries(PAUTA_TYPES).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}</select></div>
                            </div>
                            <div><label className="block text-xs font-bold text-slate-400 mb-1">DESCRIÇÃO / ROTEIRO</label><textarea name="description" value={formData.description||''} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white h-24" placeholder="Cole o roteiro aqui..." /></div>
                            <div className="bg-green-900/10 p-3 rounded border border-green-500/20"><label className="block text-xs font-bold text-green-400 mb-1 flex items-center gap-2"><Icon name="link" className="w-3 h-3" /> ATUALIZAÇÕES / LINKS (Drive, Prévias)</label><textarea name="updates" value={formData.updates||''} onChange={handleChange} className="w-full bg-slate-900 border border-green-700/50 rounded p-2 text-white h-20 text-sm font-mono" placeholder="Cole aqui links do Drive, status da edição..." /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-slate-400 font-bold block mb-1">Tipo</label><select name="type" value={formData.type} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white">{Object.entries(TYPES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select></div>
                                <div><label className="text-xs text-slate-400 font-bold block mb-1">Status</label><select name="status" value={formData.status} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white">{COLUMNS.map(c=><option key={c.id} value={c.id}>{c.title}</option>)}</select></div>
                            </div>
                            {formData.type === 'reels' && (<div className="bg-purple-900/20 p-2 rounded border border-purple-500/30"><label className="text-xs text-purple-300 font-bold block mb-1">FORMATO DO REELS</label><div className="flex gap-2 flex-wrap">{REELS_FORMATS.map(fmt => (<button key={fmt.id} onClick={()=>setFormData({...formData, reelsFormat: fmt.id})} className={`text-[10px] px-2 py-1 rounded border transition-colors ${formData.reelsFormat === fmt.id ? 'bg-purple-600 border-purple-600 text-white' : 'border-purple-500/50 text-purple-200 hover:bg-purple-800/50'}`}>{fmt.label}</button>))}</div></div>)}
                            <div className="p-3 bg-blue-900/20 rounded border border-blue-500/30 grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-blue-300 font-bold">DATA POSTAGEM</label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white" /></div>
                                <div><label className="text-xs text-blue-300 font-bold">HORA</label><input type="time" name="time" value={formData.time} onChange={handleChange} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white" /></div>
                            </div>
                            <div className="p-3 bg-orange-900/20 rounded border border-orange-500/30 grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-orange-300 font-bold">DEADLINE EDIÇÃO</label><input type="date" name="deadlineDate" value={formData.deadlineDate} onChange={handleChange} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white" /></div>
                                <div><label className="text-xs text-orange-300 font-bold">HORA</label><input type="time" name="deadlineTime" value={formData.deadlineTime} onChange={handleChange} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white" /></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-slate-400 font-bold">Responsável</label><select name="assignee" value={formData.assignee} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white">{Object.entries(TEAM).map(([k,v])=><option key={k} value={k}>{v.name}</option>)}</select></div>
                                <div><label className="text-xs text-slate-400 font-bold">Prioridade</label><select name="priority" value={formData.priority} onChange={handleChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"><option value="low">Baixa</option><option value="medium">Média</option><option value="high">Alta</option></select></div>
                            </div>
                        </div>
                        <div className="p-4 bg-slate-800 flex justify-between">
                            {task.id ? <button onClick={()=>onDelete(task.id)} className="text-red-400 hover:text-red-300 text-sm"><Icon name="trash-2" className="inline w-4 h-4"/> Deletar</button> : <div></div>}
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-slate-300 hover:bg-slate-700 rounded text-sm">Cancelar</button>
                                <button onClick={()=>onSave(formData)} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded text-sm flex items-center gap-2"><Icon name="save" className="w-4 h-4"/> Salvar</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>